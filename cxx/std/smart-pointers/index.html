<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Smart Pointers | Infinity Architect</title>
<link rel=stylesheet href=/main.css><script type=importmap>
  {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.167.1/+esm"
      }
  }
  </script><script type=module src=/theme.mjs></script><style>.tag-android{background-color:hsl(0deg 80% 70%)}.dark .tag-android{background-color:hsl(0deg 80% 20%)}.tag-annotation{background-color:hsl(50deg 80% 70%)}.dark .tag-annotation{background-color:hsl(50deg 80% 20%)}.tag-assembly{background-color:hsl(100deg 80% 70%)}.dark .tag-assembly{background-color:hsl(100deg 80% 20%)}.tag-asymmetrical-cryptography{background-color:hsl(150deg 80% 70%)}.dark .tag-asymmetrical-cryptography{background-color:hsl(150deg 80% 20%)}.tag-awk{background-color:hsl(200deg 80% 70%)}.dark .tag-awk{background-color:hsl(200deg 80% 20%)}.tag-bootloader{background-color:hsl(250deg 80% 70%)}.dark .tag-bootloader{background-color:hsl(250deg 80% 20%)}.tag-bytecode{background-color:hsl(300deg 80% 70%)}.dark .tag-bytecode{background-color:hsl(300deg 80% 20%)}.tag-c{background-color:hsl(350deg 80% 70%)}.dark .tag-c{background-color:hsl(350deg 80% 20%)}.tag-cxx{background-color:hsl(40deg 80% 70%)}.dark .tag-cxx{background-color:hsl(40deg 80% 20%)}.tag-cxx-stl{background-color:hsl(90deg 80% 70%)}.dark .tag-cxx-stl{background-color:hsl(90deg 80% 20%)}.tag-cgroup{background-color:hsl(140deg 80% 70%)}.dark .tag-cgroup{background-color:hsl(140deg 80% 20%)}.tag-cheetsheet{background-color:hsl(190deg 80% 70%)}.dark .tag-cheetsheet{background-color:hsl(190deg 80% 20%)}.tag-clang{background-color:hsl(240deg 80% 70%)}.dark .tag-clang{background-color:hsl(240deg 80% 20%)}.tag-coding-theory{background-color:hsl(290deg 80% 70%)}.dark .tag-coding-theory{background-color:hsl(290deg 80% 20%)}.tag-compression{background-color:hsl(340deg 80% 70%)}.dark .tag-compression{background-color:hsl(340deg 80% 20%)}.tag-concept{background-color:hsl(30deg 80% 70%)}.dark .tag-concept{background-color:hsl(30deg 80% 20%)}.tag-cpu{background-color:hsl(80deg 80% 70%)}.dark .tag-cpu{background-color:hsl(80deg 80% 20%)}.tag-crawler{background-color:hsl(130deg 80% 70%)}.dark .tag-crawler{background-color:hsl(130deg 80% 20%)}.tag-cryptography{background-color:hsl(180deg 80% 70%)}.dark .tag-cryptography{background-color:hsl(180deg 80% 20%)}.tag-css{background-color:hsl(230deg 80% 70%)}.dark .tag-css{background-color:hsl(230deg 80% 20%)}.tag-database{background-color:hsl(280deg 80% 70%)}.dark .tag-database{background-color:hsl(280deg 80% 20%)}.tag-deflate{background-color:hsl(330deg 80% 70%)}.dark .tag-deflate{background-color:hsl(330deg 80% 20%)}.tag-design{background-color:hsl(20deg 80% 70%)}.dark .tag-design{background-color:hsl(20deg 80% 20%)}.tag-dns{background-color:hsl(70deg 80% 70%)}.dark .tag-dns{background-color:hsl(70deg 80% 20%)}.tag-dom{background-color:hsl(120deg 80% 70%)}.dark .tag-dom{background-color:hsl(120deg 80% 20%)}.tag-driver{background-color:hsl(170deg 80% 70%)}.dark .tag-driver{background-color:hsl(170deg 80% 20%)}.tag-elastic{background-color:hsl(220deg 80% 70%)}.dark .tag-elastic{background-color:hsl(220deg 80% 20%)}.tag-elf{background-color:hsl(270deg 80% 70%)}.dark .tag-elf{background-color:hsl(270deg 80% 20%)}.tag-elk{background-color:hsl(320deg 80% 70%)}.dark .tag-elk{background-color:hsl(320deg 80% 20%)}.tag-flex{background-color:hsl(10deg 80% 70%)}.dark .tag-flex{background-color:hsl(10deg 80% 20%)}.tag-gc{background-color:hsl(60deg 80% 70%)}.dark .tag-gc{background-color:hsl(60deg 80% 20%)}.tag-gcc{background-color:hsl(110deg 80% 70%)}.dark .tag-gcc{background-color:hsl(110deg 80% 20%)}.tag-gnu{background-color:hsl(160deg 80% 70%)}.dark .tag-gnu{background-color:hsl(160deg 80% 20%)}.tag-go{background-color:hsl(210deg 80% 70%)}.dark .tag-go{background-color:hsl(210deg 80% 20%)}.tag-gzip{background-color:hsl(260deg 80% 70%)}.dark .tag-gzip{background-color:hsl(260deg 80% 20%)}.tag-hash{background-color:hsl(310deg 80% 70%)}.dark .tag-hash{background-color:hsl(310deg 80% 20%)}.tag-http{background-color:hsl(0deg 80% 70%)}.dark .tag-http{background-color:hsl(0deg 80% 20%)}.tag-huffman{background-color:hsl(50deg 80% 70%)}.dark .tag-huffman{background-color:hsl(50deg 80% 20%)}.tag-java{background-color:hsl(100deg 80% 70%)}.dark .tag-java{background-color:hsl(100deg 80% 20%)}.tag-java-module{background-color:hsl(150deg 80% 70%)}.dark .tag-java-module{background-color:hsl(150deg 80% 20%)}.tag-javascript{background-color:hsl(200deg 80% 70%)}.dark .tag-javascript{background-color:hsl(200deg 80% 20%)}.tag-jdk{background-color:hsl(250deg 80% 70%)}.dark .tag-jdk{background-color:hsl(250deg 80% 20%)}.tag-js{background-color:hsl(300deg 80% 70%)}.dark .tag-js{background-color:hsl(300deg 80% 20%)}.tag-jvm{background-color:hsl(350deg 80% 70%)}.dark .tag-jvm{background-color:hsl(350deg 80% 20%)}.tag-kernel{background-color:hsl(40deg 80% 70%)}.dark .tag-kernel{background-color:hsl(40deg 80% 20%)}.tag-lexer{background-color:hsl(90deg 80% 70%)}.dark .tag-lexer{background-color:hsl(90deg 80% 20%)}.tag-linux{background-color:hsl(140deg 80% 70%)}.dark .tag-linux{background-color:hsl(140deg 80% 20%)}.tag-log4j2{background-color:hsl(190deg 80% 70%)}.dark .tag-log4j2{background-color:hsl(190deg 80% 20%)}.tag-lz77{background-color:hsl(240deg 80% 70%)}.dark .tag-lz77{background-color:hsl(240deg 80% 20%)}.tag-make{background-color:hsl(290deg 80% 70%)}.dark .tag-make{background-color:hsl(290deg 80% 20%)}.tag-makefile{background-color:hsl(340deg 80% 70%)}.dark .tag-makefile{background-color:hsl(340deg 80% 20%)}.tag-maven{background-color:hsl(30deg 80% 70%)}.dark .tag-maven{background-color:hsl(30deg 80% 20%)}.tag-memory{background-color:hsl(80deg 80% 70%)}.dark .tag-memory{background-color:hsl(80deg 80% 20%)}.tag-multithreading{background-color:hsl(130deg 80% 70%)}.dark .tag-multithreading{background-color:hsl(130deg 80% 20%)}.tag-mybatis{background-color:hsl(180deg 80% 70%)}.dark .tag-mybatis{background-color:hsl(180deg 80% 20%)}.tag-mysql{background-color:hsl(230deg 80% 70%)}.dark .tag-mysql{background-color:hsl(230deg 80% 20%)}.tag-nasm{background-color:hsl(280deg 80% 70%)}.dark .tag-nasm{background-color:hsl(280deg 80% 20%)}.tag-node{background-color:hsl(330deg 80% 70%)}.dark .tag-node{background-color:hsl(330deg 80% 20%)}.tag-nodejs{background-color:hsl(20deg 80% 70%)}.dark .tag-nodejs{background-color:hsl(20deg 80% 20%)}.tag-openssl{background-color:hsl(70deg 80% 70%)}.dark .tag-openssl{background-color:hsl(70deg 80% 20%)}.tag-playwright{background-color:hsl(120deg 80% 70%)}.dark .tag-playwright{background-color:hsl(120deg 80% 20%)}.tag-posix{background-color:hsl(170deg 80% 70%)}.dark .tag-posix{background-color:hsl(170deg 80% 20%)}.tag-powershell{background-color:hsl(220deg 80% 70%)}.dark .tag-powershell{background-color:hsl(220deg 80% 20%)}.tag-programming-langauge{background-color:hsl(270deg 80% 70%)}.dark .tag-programming-langauge{background-color:hsl(270deg 80% 20%)}.tag-programming-language{background-color:hsl(320deg 80% 70%)}.dark .tag-programming-language{background-color:hsl(320deg 80% 20%)}.tag-qemu{background-color:hsl(10deg 80% 70%)}.dark .tag-qemu{background-color:hsl(10deg 80% 20%)}.tag-redis{background-color:hsl(60deg 80% 70%)}.dark .tag-redis{background-color:hsl(60deg 80% 20%)}.tag-retrocomputing{background-color:hsl(110deg 80% 70%)}.dark .tag-retrocomputing{background-color:hsl(110deg 80% 20%)}.tag-rfc{background-color:hsl(160deg 80% 70%)}.dark .tag-rfc{background-color:hsl(160deg 80% 20%)}.tag-sdram{background-color:hsl(210deg 80% 70%)}.dark .tag-sdram{background-color:hsl(210deg 80% 20%)}.tag-sed{background-color:hsl(260deg 80% 70%)}.dark .tag-sed{background-color:hsl(260deg 80% 20%)}.tag-slf4j{background-color:hsl(310deg 80% 70%)}.dark .tag-slf4j{background-color:hsl(310deg 80% 20%)}.tag-spring{background-color:hsl(0deg 80% 70%)}.dark .tag-spring{background-color:hsl(0deg 80% 20%)}.tag-spring-boot{background-color:hsl(50deg 80% 70%)}.dark .tag-spring-boot{background-color:hsl(50deg 80% 20%)}.tag-spring-data{background-color:hsl(100deg 80% 70%)}.dark .tag-spring-data{background-color:hsl(100deg 80% 20%)}.tag-spring-ioc{background-color:hsl(150deg 80% 70%)}.dark .tag-spring-ioc{background-color:hsl(150deg 80% 20%)}.tag-sql{background-color:hsl(200deg 80% 70%)}.dark .tag-sql{background-color:hsl(200deg 80% 20%)}.tag-streaming{background-color:hsl(250deg 80% 70%)}.dark .tag-streaming{background-color:hsl(250deg 80% 20%)}.tag-template{background-color:hsl(300deg 80% 70%)}.dark .tag-template{background-color:hsl(300deg 80% 20%)}.tag-testing{background-color:hsl(350deg 80% 70%)}.dark .tag-testing{background-color:hsl(350deg 80% 20%)}.tag-thymeleaf{background-color:hsl(40deg 80% 70%)}.dark .tag-thymeleaf{background-color:hsl(40deg 80% 20%)}.tag-tls{background-color:hsl(90deg 80% 70%)}.dark .tag-tls{background-color:hsl(90deg 80% 20%)}.tag-tomcat{background-color:hsl(140deg 80% 70%)}.dark .tag-tomcat{background-color:hsl(140deg 80% 20%)}.tag-transaction{background-color:hsl(190deg 80% 70%)}.dark .tag-transaction{background-color:hsl(190deg 80% 20%)}.tag-transistor{background-color:hsl(240deg 80% 70%)}.dark .tag-transistor{background-color:hsl(240deg 80% 20%)}.tag-ts{background-color:hsl(290deg 80% 70%)}.dark .tag-ts{background-color:hsl(290deg 80% 20%)}.tag-typescript{background-color:hsl(340deg 80% 70%)}.dark .tag-typescript{background-color:hsl(340deg 80% 20%)}.tag-unix{background-color:hsl(30deg 80% 70%)}.dark .tag-unix{background-color:hsl(30deg 80% 20%)}.tag-web{background-color:hsl(80deg 80% 70%)}.dark .tag-web{background-color:hsl(80deg 80% 20%)}.tag-x86{background-color:hsl(130deg 80% 70%)}.dark .tag-x86{background-color:hsl(130deg 80% 20%)}.tag-x86_64{background-color:hsl(180deg 80% 70%)}.dark .tag-x86_64{background-color:hsl(180deg 80% 20%)}.tag-x86-64{background-color:hsl(230deg 80% 70%)}.dark .tag-x86-64{background-color:hsl(230deg 80% 20%)}.tag-xpath{background-color:hsl(280deg 80% 70%)}.dark .tag-xpath{background-color:hsl(280deg 80% 20%)}.tag-zlib{background-color:hsl(330deg 80% 70%)}.dark .tag-zlib{background-color:hsl(330deg 80% 20%)}</style></head><body><script>localStorage.getItem("dark-theme")&&document.body.classList.add("dark")</script><header><h2 id=banner><a href=/>Infinity Architect</a></h2><div id=top-sections><a href=/android/ class=hoverable>Android </a><a href=/cxx/ class=active>C/C++ </a><a href=/compression/ class=hoverable>Compression </a><a href=/cpu/ class=hoverable>CPU </a><a href=/crypto/ class=hoverable>Cryptography </a><a href=/db/ class=hoverable>Database </a><a href=/ee/ class=hoverable>Electronic Engineering </a><a href=/linux/ class=hoverable>GNU/Linux </a><a href=/go/ class=hoverable>Golang </a><a href=/java/ class=hoverable>Java </a><a href=/microservice/ class=hoverable>Microservice </a><a href=/net/ class=hoverable>Network & Protocol </a><a href=/physics/ class=hoverable>Physics </a><a href=/retro/ class=hoverable>Retro-Computing </a><a href=/toy/ class=hoverable>Toys </a><a href=/windev/ class=hoverable>Window</a></div><div class=theme-switch style="align-self:center;margin:auto 20px"><input type=checkbox id=theme-checkbox>
<label for=theme-checkbox><div></div><span><svg viewBox="0 0 24 24" fill="currentcolor" class="w-6 h-6"><path fill-rule="evenodd" d="M9.528 1.718a.75.75.0 01.162.819A8.97 8.97.0 009 6a9 9 0 009 9 8.97 8.97.0 003.463-.69.75.75.0 01.981.98 10.503 10.503.0 01-9.694 6.46c-5.799.0-10.5-4.701-10.5-10.5.0-4.368 2.667-8.112 6.46-9.694a.75.75.0 01.818.162z" clip-rule="evenodd"/></svg>
</span><span><svg viewBox="0 0 24 24" fill="currentcolor" class="w-6 h-6"><path d="M12 2.25a.75.75.0 01.75.75v2.25a.75.75.0 01-1.5.0V3a.75.75.0 01.75-.75zM7.5 12a4.5 4.5.0 119 0 4.5 4.5.0 01-9 0zM18.894 6.166a.75.75.0 00-1.06-1.06l-1.591 1.59a.75.75.0 101.06 1.061l1.591-1.59zM21.75 12a.75.75.0 01-.75.75h-2.25a.75.75.0 010-1.5H21a.75.75.0 01.75.75zm-3.916 6.894a.75.75.0 001.06-1.06l-1.59-1.591a.75.75.0 10-1.061 1.06l1.59 1.591zM12 18a.75.75.0 01.75.75V21a.75.75.0 01-1.5.0v-2.25A.75.75.0 0112 18zM7.758 17.303a.75.75.0 00-1.061-1.06l-1.591 1.59a.75.75.0 001.06 1.061l1.591-1.59zM6 12a.75.75.0 01-.75.75H3a.75.75.0 010-1.5h2.25A.75.75.0 016 12zm.697-4.243a.75.75.0 001.06-1.06l-1.59-1.591a.75.75.0 00-1.061 1.06l1.59 1.591z"/></svg></span></label></div></header><main><article class=basic-text><div style=font-family:monospace;font-size:1.5em><div class=basic-text>/<a href=/>HOME</a>/<a href=/cxx/>C/C++</a>/<a href=/cxx/std/>C++ Standard Library</a>/
$</div></div><div style=margin-bottom:60px><h1 style=margin-bottom:0>Smart Pointers</h1><p class=aux-text style=margin-top:0>Published at: April 27, 2024
| Last modification: April 30, 2024</p><div style=line-height:2em><span class="page-tag tag-cxx">C++</span>
<span class="page-tag tag-cxx-stl">C++ STL</span></div></div><div><h2 id=when-not-to-use-smart-pointer>When not to use smart pointer</h2><p>Guideline:</p><ul><li>raw pointer with <code>new</code> expression is always bad.</li><li>there are situation in modern C++ where raw pointers make perfect sense.</li></ul><h3 id=when-destruction-of-resources-is-potentially-throwing>when destruction of resources is potentially-throwing</h3><p>Exception can&rsquo;t be thrown from deleter. Use classic RAII class with <code>noexcept(false)</code> public API and <code>noexcept(true)</code> dtor instead of smart pointer.</p><p><a href=https://stackoverflow.com/questions/130117/if-you-shouldnt-throw-exceptions-in-a-destructor-how-do-you-handle-errors-in-i>https://stackoverflow.com/questions/130117/if-you-shouldnt-throw-exceptions-in-a-destructor-how-do-you-handle-errors-in-i</a></p><p>RAII class should be kept simple: never own 2 resources in 1 class.</p><ul><li><a href="https://docs.microsoft.com/en-us/cpp/cpp/how-to-design-for-exception-safety?view=msvc-170#keep-resource-classes-simple">Microsoft guide mentioned this</a></li><li>(TODO: Bad things happends when RAII class wraps 2 resources?)</li></ul><h3 id=never-use-smart-pointer-to-static-memory>Never use smart pointer to static memory</h3><p>Ownership semantics doesn&rsquo;t make sense for static memory: no object owns them.</p><ul><li>Usually native reference is enough. This explicitizes the intention that lifetime is not a problem.</li><li>Native reference as class data member requires reference initialization in <code>member-init-list</code>, prior to the constructor body can be executed. This can be a problem if certain computation is needed to determine which static object these references bind to. Consider named constructor idiom instead. <code>std:reference_wrapper</code> provides mutability, but cannot be empty, thus is not an option for lazy init.</li></ul><h2 id=unique_ptr><code>unique_ptr</code></h2><p>To construct an instance of <code>unique_ptr</code>, use one of</p><ul><li>Ctor of <code>unique_ptr</code>, which allows custom deleter, but suffers from 1) redundant type spelling 2) unspecified order of argument evaluation</li><li><code>std::make_unique</code> (since c++14), which can&rsquo;t have custom deleter, but avoid ctor&rsquo;s defects by perferct-forwarding arguments to the resolved ctor.</li><li><code>std::make_unique_for_overwrite</code> (since c++20)</li></ul><h2 id=deleter>deleter</h2><p>Deleter must be an <em>FunctionObject</em> callable with a single argument <code>T*</code>.</p><p>Deleter is part of <code>unique_ptr</code>&rsquo;s type parameter, which forbids &mldr;</p><p>For custom deleter, (TODO: why)</p><ul><li>Captureless lambda as deleter incur no size penalty.</li><li>Ordinary function as deleter increase the size of each <code>unique_ptr</code> instance to 2 pointer</li></ul><h2 id=shared_ptr><code>shared_ptr</code></h2><p>TODO</p><h3 id=stdmake_shared><code>std::make_shared</code></h3><h3 id=shared_ptr-to-this><code>shared_ptr</code> to <code>this</code></h3><h3 id=internals>internals</h3><h2 id=weak_ptr><code>weak_ptr</code></h2><ul><li><p><code>weak_ptr</code> can&rsquo;t prevent the pointed resources being deleted as a result of all <code>shared_ptr</code>s being destructed.</p></li><li><p>Conceptually <code>weak_ptr</code> is associated with the underlying resources, rather than a specific <code>shared_ptr</code> instance:</p><div class=codeblock-hook><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>auto</span> shared <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>make_shared<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span>(<span style=color:#ae81ff>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>auto</span> weak <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>weak_ptr(shared);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>shared <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>make_shared<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span>(<span style=color:#ae81ff>99</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#66d9ef>if</span> (weak.expired()) { <span style=color:#75715e>// true
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#75715e></span>    std<span style=color:#f92672>::</span>puts(<span style=color:#e6db74>&#34;weak expired&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>}</span></span></code></pre></div><button>copy</button></div></li></ul><p>To convert <code>weak_ptr</code> to a <code>shared_ptr</code>, use either of</p><table><thead><tr><th></th><th>when <code>expired() == true</code></th></tr></thead><tbody><tr><td><code>weak_ptr::lock()</code></td><td>return an empty <code>shared_ptr</code></td></tr><tr><td><code>shared_ptr(const std::weak_ptr&lt;T>&)</code> ctor</td><td>throws <code>std::bad_weak_ptr</code></td></tr></tbody></table><h2 id=make_unique-and-make_shared><code>make_unique</code> and <code>make_shared</code></h2><h3 id=the-unspecified-evaluation-order-problem>the unspecified-evaluation-order problem</h3><p>In C++14, the following was unsafe:</p><div class=codeblock-hook><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>foo</span>(std<span style=color:#f92672>::</span>unique_ptr<span style=color:#f92672>&lt;</span>A<span style=color:#f92672>&gt;</span>, std<span style=color:#f92672>::</span>unique_ptr<span style=color:#f92672>&lt;</span>B<span style=color:#f92672>&gt;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>foo(std<span style=color:#f92672>::</span>unique_ptr<span style=color:#f92672>&lt;</span>A<span style=color:#f92672>&gt;</span>(<span style=color:#66d9ef>new</span> A), std<span style=color:#f92672>::</span>unique_ptr<span style=color:#f92672>&lt;</span>B<span style=color:#f92672>&gt;</span>(<span style=color:#66d9ef>new</span> B));</span></span></code></pre></div><button>copy</button></div><p>There are four operations that happen here during the function call</p><ol><li><code>new A</code></li><li><code>unique_ptr&lt;A></code> constructor</li><li><code>new B</code></li><li><code>unique_ptr&lt;B></code> constructor</li></ol><p>C++14 and prior specification leaves the ordering of these completely unspecified, thus <code>(1), (3), (2), (4)</code> is a perfectly valid ordering.
If (3) throws, then the memory from (1) leaks - we haven&rsquo;t run (2) yet, which would&rsquo;ve prevented the leak.</p><p>Such interleaving of evaluation is prohibited in C++17:</p><blockquote><p>For each function invocation &mldr; F, each evaluation (in the same thread) that does not occur within F &mldr;
is either sequenced before or sequenced after all evaluations that occur within F.
<a href=https://eel.is/c++draft/intro.execution#11>cite: c++23 working draft</a></p></blockquote><ul><li>Let <code>F</code> denote <code>std::unique_ptr&lt;A>(new A)</code>, this guaranteed <code>new B</code> and <code>unique_ptr&lt;B></code> ctor sequenced before or after <code>new A</code> as a whole.</li><li>Let <code>F</code> denote <code>std::unique_ptr&lt;B>(new B)</code>, this guaranteed <code>new A</code> and <code>unique_ptr&lt;A></code> ctor sequenced before or after <code>new B</code> as a whole.</li><li>Combined, this denies any intermediate evaluation bewtween <code>arg_expr</code> and <code>func_name(arg_expr)</code> call, regardless how many arbitrarily nested function calls appear in the same expression.</li></ul><h2 id=c17-ctad-doesnt-make-raw-use-of-ctor-better>C++17 CTAD doesn&rsquo;t make raw use of ctor better</h2><h3 id=make_unique>make_unique</h3><div class=codeblock-hook><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>std<span style=color:#f92672>::</span>unique_ptr<span style=color:#f92672>&lt;</span>Foo<span style=color:#f92672>&gt;</span> foo_up1{<span style=color:#66d9ef>new</span> Foo{a,b,c}};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>auto</span> foo_up2 <span style=color:#f92672>=</span> std<span style=color:#f92672>::</span>make_unique<span style=color:#f92672>&lt;</span>Foo<span style=color:#f92672>&gt;</span>(a,b,c);</span></span></code></pre></div><button>copy</button></div><ol><li><p><code>make_unique</code> saves you from spelling the <code>Foo</code> twice.</p></li><li><p><code>make_unique</code> prevents the unspecified-evaluation-order problem in pre-c++17 environment:</p><div class=codeblock-hook><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>bar(std<span style=color:#f92672>::</span>unique_ptr<span style=color:#f92672>&lt;</span>Foo<span style=color:#f92672>&gt;</span>(<span style=color:#66d9ef>new</span> Foo), std<span style=color:#f92672>::</span>unique_ptr<span style=color:#f92672>&lt;</span>Bar<span style=color:#f92672>&gt;</span>(<span style=color:#66d9ef>new</span> Bar));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>bar(std<span style=color:#f92672>::</span>make_unique<span style=color:#f92672>&lt;</span>Foo<span style=color:#f92672>&gt;</span>(), std<span style=color:#f92672>::</span>make_unique<span style=color:#f92672>&lt;</span>Bar<span style=color:#f92672>&gt;</span>());</span></span></code></pre></div><button>copy</button></div></li><li><p>Exterminate the last need of typing <code>new</code>.</p></li></ol><h3 id=when-not-to-use-make_>When not to use <code>make_*</code></h3><ol><li>When you need a custom deleter</li><li>When you are adopting an existing raw pointer from elsewhere.</li></ol></div></article></main><footer>Unless otherwise noted, content of this site is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ style=text-decoration:underline>the CC BY-NC-SA 4.0</a>.<br>cesun.info copyright 2024.</footer></body></html>