<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Evolution of x86 Memory Organization | Infinity Architect</title>
<link rel=stylesheet href=/main.css><script type=importmap>
  {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.167.1/+esm"
      }
  }
  </script><script type=module src=/theme.mjs></script><style>.tag-android{background-color:hsl(0deg 80% 70%)}.dark .tag-android{background-color:hsl(0deg 80% 20%)}.tag-annotation{background-color:hsl(50deg 80% 70%)}.dark .tag-annotation{background-color:hsl(50deg 80% 20%)}.tag-assembly{background-color:hsl(100deg 80% 70%)}.dark .tag-assembly{background-color:hsl(100deg 80% 20%)}.tag-asymmetrical-cryptography{background-color:hsl(150deg 80% 70%)}.dark .tag-asymmetrical-cryptography{background-color:hsl(150deg 80% 20%)}.tag-awk{background-color:hsl(200deg 80% 70%)}.dark .tag-awk{background-color:hsl(200deg 80% 20%)}.tag-bootloader{background-color:hsl(250deg 80% 70%)}.dark .tag-bootloader{background-color:hsl(250deg 80% 20%)}.tag-bytecode{background-color:hsl(300deg 80% 70%)}.dark .tag-bytecode{background-color:hsl(300deg 80% 20%)}.tag-c{background-color:hsl(350deg 80% 70%)}.dark .tag-c{background-color:hsl(350deg 80% 20%)}.tag-cxx{background-color:hsl(40deg 80% 70%)}.dark .tag-cxx{background-color:hsl(40deg 80% 20%)}.tag-cxx-stl{background-color:hsl(90deg 80% 70%)}.dark .tag-cxx-stl{background-color:hsl(90deg 80% 20%)}.tag-cgroup{background-color:hsl(140deg 80% 70%)}.dark .tag-cgroup{background-color:hsl(140deg 80% 20%)}.tag-cheetsheet{background-color:hsl(190deg 80% 70%)}.dark .tag-cheetsheet{background-color:hsl(190deg 80% 20%)}.tag-clang{background-color:hsl(240deg 80% 70%)}.dark .tag-clang{background-color:hsl(240deg 80% 20%)}.tag-coding-theory{background-color:hsl(290deg 80% 70%)}.dark .tag-coding-theory{background-color:hsl(290deg 80% 20%)}.tag-compression{background-color:hsl(340deg 80% 70%)}.dark .tag-compression{background-color:hsl(340deg 80% 20%)}.tag-concept{background-color:hsl(30deg 80% 70%)}.dark .tag-concept{background-color:hsl(30deg 80% 20%)}.tag-cpu{background-color:hsl(80deg 80% 70%)}.dark .tag-cpu{background-color:hsl(80deg 80% 20%)}.tag-crawler{background-color:hsl(130deg 80% 70%)}.dark .tag-crawler{background-color:hsl(130deg 80% 20%)}.tag-cryptography{background-color:hsl(180deg 80% 70%)}.dark .tag-cryptography{background-color:hsl(180deg 80% 20%)}.tag-css{background-color:hsl(230deg 80% 70%)}.dark .tag-css{background-color:hsl(230deg 80% 20%)}.tag-database{background-color:hsl(280deg 80% 70%)}.dark .tag-database{background-color:hsl(280deg 80% 20%)}.tag-deflate{background-color:hsl(330deg 80% 70%)}.dark .tag-deflate{background-color:hsl(330deg 80% 20%)}.tag-design{background-color:hsl(20deg 80% 70%)}.dark .tag-design{background-color:hsl(20deg 80% 20%)}.tag-dns{background-color:hsl(70deg 80% 70%)}.dark .tag-dns{background-color:hsl(70deg 80% 20%)}.tag-dom{background-color:hsl(120deg 80% 70%)}.dark .tag-dom{background-color:hsl(120deg 80% 20%)}.tag-driver{background-color:hsl(170deg 80% 70%)}.dark .tag-driver{background-color:hsl(170deg 80% 20%)}.tag-elastic{background-color:hsl(220deg 80% 70%)}.dark .tag-elastic{background-color:hsl(220deg 80% 20%)}.tag-elf{background-color:hsl(270deg 80% 70%)}.dark .tag-elf{background-color:hsl(270deg 80% 20%)}.tag-elk{background-color:hsl(320deg 80% 70%)}.dark .tag-elk{background-color:hsl(320deg 80% 20%)}.tag-flex{background-color:hsl(10deg 80% 70%)}.dark .tag-flex{background-color:hsl(10deg 80% 20%)}.tag-gc{background-color:hsl(60deg 80% 70%)}.dark .tag-gc{background-color:hsl(60deg 80% 20%)}.tag-gcc{background-color:hsl(110deg 80% 70%)}.dark .tag-gcc{background-color:hsl(110deg 80% 20%)}.tag-gnu{background-color:hsl(160deg 80% 70%)}.dark .tag-gnu{background-color:hsl(160deg 80% 20%)}.tag-go{background-color:hsl(210deg 80% 70%)}.dark .tag-go{background-color:hsl(210deg 80% 20%)}.tag-gzip{background-color:hsl(260deg 80% 70%)}.dark .tag-gzip{background-color:hsl(260deg 80% 20%)}.tag-hash{background-color:hsl(310deg 80% 70%)}.dark .tag-hash{background-color:hsl(310deg 80% 20%)}.tag-http{background-color:hsl(0deg 80% 70%)}.dark .tag-http{background-color:hsl(0deg 80% 20%)}.tag-huffman{background-color:hsl(50deg 80% 70%)}.dark .tag-huffman{background-color:hsl(50deg 80% 20%)}.tag-java{background-color:hsl(100deg 80% 70%)}.dark .tag-java{background-color:hsl(100deg 80% 20%)}.tag-java-module{background-color:hsl(150deg 80% 70%)}.dark .tag-java-module{background-color:hsl(150deg 80% 20%)}.tag-javascript{background-color:hsl(200deg 80% 70%)}.dark .tag-javascript{background-color:hsl(200deg 80% 20%)}.tag-jdk{background-color:hsl(250deg 80% 70%)}.dark .tag-jdk{background-color:hsl(250deg 80% 20%)}.tag-js{background-color:hsl(300deg 80% 70%)}.dark .tag-js{background-color:hsl(300deg 80% 20%)}.tag-jvm{background-color:hsl(350deg 80% 70%)}.dark .tag-jvm{background-color:hsl(350deg 80% 20%)}.tag-kernel{background-color:hsl(40deg 80% 70%)}.dark .tag-kernel{background-color:hsl(40deg 80% 20%)}.tag-lexer{background-color:hsl(90deg 80% 70%)}.dark .tag-lexer{background-color:hsl(90deg 80% 20%)}.tag-linux{background-color:hsl(140deg 80% 70%)}.dark .tag-linux{background-color:hsl(140deg 80% 20%)}.tag-log4j2{background-color:hsl(190deg 80% 70%)}.dark .tag-log4j2{background-color:hsl(190deg 80% 20%)}.tag-lz77{background-color:hsl(240deg 80% 70%)}.dark .tag-lz77{background-color:hsl(240deg 80% 20%)}.tag-make{background-color:hsl(290deg 80% 70%)}.dark .tag-make{background-color:hsl(290deg 80% 20%)}.tag-makefile{background-color:hsl(340deg 80% 70%)}.dark .tag-makefile{background-color:hsl(340deg 80% 20%)}.tag-maven{background-color:hsl(30deg 80% 70%)}.dark .tag-maven{background-color:hsl(30deg 80% 20%)}.tag-memory{background-color:hsl(80deg 80% 70%)}.dark .tag-memory{background-color:hsl(80deg 80% 20%)}.tag-multithreading{background-color:hsl(130deg 80% 70%)}.dark .tag-multithreading{background-color:hsl(130deg 80% 20%)}.tag-mybatis{background-color:hsl(180deg 80% 70%)}.dark .tag-mybatis{background-color:hsl(180deg 80% 20%)}.tag-mysql{background-color:hsl(230deg 80% 70%)}.dark .tag-mysql{background-color:hsl(230deg 80% 20%)}.tag-nasm{background-color:hsl(280deg 80% 70%)}.dark .tag-nasm{background-color:hsl(280deg 80% 20%)}.tag-node{background-color:hsl(330deg 80% 70%)}.dark .tag-node{background-color:hsl(330deg 80% 20%)}.tag-nodejs{background-color:hsl(20deg 80% 70%)}.dark .tag-nodejs{background-color:hsl(20deg 80% 20%)}.tag-openssl{background-color:hsl(70deg 80% 70%)}.dark .tag-openssl{background-color:hsl(70deg 80% 20%)}.tag-playwright{background-color:hsl(120deg 80% 70%)}.dark .tag-playwright{background-color:hsl(120deg 80% 20%)}.tag-posix{background-color:hsl(170deg 80% 70%)}.dark .tag-posix{background-color:hsl(170deg 80% 20%)}.tag-powershell{background-color:hsl(220deg 80% 70%)}.dark .tag-powershell{background-color:hsl(220deg 80% 20%)}.tag-programming-langauge{background-color:hsl(270deg 80% 70%)}.dark .tag-programming-langauge{background-color:hsl(270deg 80% 20%)}.tag-programming-language{background-color:hsl(320deg 80% 70%)}.dark .tag-programming-language{background-color:hsl(320deg 80% 20%)}.tag-qemu{background-color:hsl(10deg 80% 70%)}.dark .tag-qemu{background-color:hsl(10deg 80% 20%)}.tag-redis{background-color:hsl(60deg 80% 70%)}.dark .tag-redis{background-color:hsl(60deg 80% 20%)}.tag-retrocomputing{background-color:hsl(110deg 80% 70%)}.dark .tag-retrocomputing{background-color:hsl(110deg 80% 20%)}.tag-rfc{background-color:hsl(160deg 80% 70%)}.dark .tag-rfc{background-color:hsl(160deg 80% 20%)}.tag-sdram{background-color:hsl(210deg 80% 70%)}.dark .tag-sdram{background-color:hsl(210deg 80% 20%)}.tag-sed{background-color:hsl(260deg 80% 70%)}.dark .tag-sed{background-color:hsl(260deg 80% 20%)}.tag-slf4j{background-color:hsl(310deg 80% 70%)}.dark .tag-slf4j{background-color:hsl(310deg 80% 20%)}.tag-spring{background-color:hsl(0deg 80% 70%)}.dark .tag-spring{background-color:hsl(0deg 80% 20%)}.tag-spring-boot{background-color:hsl(50deg 80% 70%)}.dark .tag-spring-boot{background-color:hsl(50deg 80% 20%)}.tag-spring-data{background-color:hsl(100deg 80% 70%)}.dark .tag-spring-data{background-color:hsl(100deg 80% 20%)}.tag-spring-ioc{background-color:hsl(150deg 80% 70%)}.dark .tag-spring-ioc{background-color:hsl(150deg 80% 20%)}.tag-sql{background-color:hsl(200deg 80% 70%)}.dark .tag-sql{background-color:hsl(200deg 80% 20%)}.tag-streaming{background-color:hsl(250deg 80% 70%)}.dark .tag-streaming{background-color:hsl(250deg 80% 20%)}.tag-template{background-color:hsl(300deg 80% 70%)}.dark .tag-template{background-color:hsl(300deg 80% 20%)}.tag-testing{background-color:hsl(350deg 80% 70%)}.dark .tag-testing{background-color:hsl(350deg 80% 20%)}.tag-thymeleaf{background-color:hsl(40deg 80% 70%)}.dark .tag-thymeleaf{background-color:hsl(40deg 80% 20%)}.tag-tls{background-color:hsl(90deg 80% 70%)}.dark .tag-tls{background-color:hsl(90deg 80% 20%)}.tag-tomcat{background-color:hsl(140deg 80% 70%)}.dark .tag-tomcat{background-color:hsl(140deg 80% 20%)}.tag-transaction{background-color:hsl(190deg 80% 70%)}.dark .tag-transaction{background-color:hsl(190deg 80% 20%)}.tag-transistor{background-color:hsl(240deg 80% 70%)}.dark .tag-transistor{background-color:hsl(240deg 80% 20%)}.tag-ts{background-color:hsl(290deg 80% 70%)}.dark .tag-ts{background-color:hsl(290deg 80% 20%)}.tag-typescript{background-color:hsl(340deg 80% 70%)}.dark .tag-typescript{background-color:hsl(340deg 80% 20%)}.tag-unix{background-color:hsl(30deg 80% 70%)}.dark .tag-unix{background-color:hsl(30deg 80% 20%)}.tag-web{background-color:hsl(80deg 80% 70%)}.dark .tag-web{background-color:hsl(80deg 80% 20%)}.tag-x86{background-color:hsl(130deg 80% 70%)}.dark .tag-x86{background-color:hsl(130deg 80% 20%)}.tag-x86_64{background-color:hsl(180deg 80% 70%)}.dark .tag-x86_64{background-color:hsl(180deg 80% 20%)}.tag-x86-64{background-color:hsl(230deg 80% 70%)}.dark .tag-x86-64{background-color:hsl(230deg 80% 20%)}.tag-xpath{background-color:hsl(280deg 80% 70%)}.dark .tag-xpath{background-color:hsl(280deg 80% 20%)}.tag-zlib{background-color:hsl(330deg 80% 70%)}.dark .tag-zlib{background-color:hsl(330deg 80% 20%)}</style></head><body><script>localStorage.getItem("dark-theme")&&document.body.classList.add("dark")</script><header><h2 id=banner><a href=/>Infinity Architect</a></h2><div id=top-sections><a href=/android/ class=hoverable>Android </a><a href=/cxx/ class=hoverable>C/C++ </a><a href=/compression/ class=hoverable>Compression </a><a href=/cpu/ class=active>CPU </a><a href=/crypto/ class=hoverable>Cryptography </a><a href=/db/ class=hoverable>Database </a><a href=/ee/ class=hoverable>Electronic Engineering </a><a href=/linux/ class=hoverable>GNU/Linux </a><a href=/go/ class=hoverable>Golang </a><a href=/java/ class=hoverable>Java </a><a href=/microservice/ class=hoverable>Microservice </a><a href=/net/ class=hoverable>Network & Protocol </a><a href=/physics/ class=hoverable>Physics </a><a href=/retro/ class=hoverable>Retro-Computing </a><a href=/toy/ class=hoverable>Toys </a><a href=/windev/ class=hoverable>Window</a></div><div class=theme-switch style="align-self:center;margin:auto 20px"><input type=checkbox id=theme-checkbox>
<label for=theme-checkbox><div></div><span><svg viewBox="0 0 24 24" fill="currentcolor" class="w-6 h-6"><path fill-rule="evenodd" d="M9.528 1.718a.75.75.0 01.162.819A8.97 8.97.0 009 6a9 9 0 009 9 8.97 8.97.0 003.463-.69.75.75.0 01.981.98 10.503 10.503.0 01-9.694 6.46c-5.799.0-10.5-4.701-10.5-10.5.0-4.368 2.667-8.112 6.46-9.694a.75.75.0 01.818.162z" clip-rule="evenodd"/></svg>
</span><span><svg viewBox="0 0 24 24" fill="currentcolor" class="w-6 h-6"><path d="M12 2.25a.75.75.0 01.75.75v2.25a.75.75.0 01-1.5.0V3a.75.75.0 01.75-.75zM7.5 12a4.5 4.5.0 119 0 4.5 4.5.0 01-9 0zM18.894 6.166a.75.75.0 00-1.06-1.06l-1.591 1.59a.75.75.0 101.06 1.061l1.591-1.59zM21.75 12a.75.75.0 01-.75.75h-2.25a.75.75.0 010-1.5H21a.75.75.0 01.75.75zm-3.916 6.894a.75.75.0 001.06-1.06l-1.59-1.591a.75.75.0 10-1.061 1.06l1.59 1.591zM12 18a.75.75.0 01.75.75V21a.75.75.0 01-1.5.0v-2.25A.75.75.0 0112 18zM7.758 17.303a.75.75.0 00-1.061-1.06l-1.591 1.59a.75.75.0 001.06 1.061l1.591-1.59zM6 12a.75.75.0 01-.75.75H3a.75.75.0 010-1.5h2.25A.75.75.0 016 12zm.697-4.243a.75.75.0 001.06-1.06l-1.59-1.591a.75.75.0 00-1.061 1.06l1.59 1.591z"/></svg></span></label></div></header><main><article class=basic-text><div style=font-family:monospace;font-size:1.5em><div class=basic-text>/<a href=/>HOME</a>/<a href=/cpu/>CPU</a>/<a href=/cpu/x86/>x86 Architecture</a>/
$</div></div><div style=margin-bottom:60px><h1 style=margin-bottom:0>Evolution of x86 Memory Organization</h1><p class=aux-text style=margin-top:0>Published at: September 1, 2023
| Last modification: July 29, 2024</p><div style=line-height:2em><span class="page-tag tag-cpu">CPU</span>
<span class="page-tag tag-memory">memory</span>
<span class="page-tag tag-x86">x86</span>
<span class="page-tag tag-x86-64">x86-64</span></div></div><div><p>This article discusses the memory organization from an x86 CPU&rsquo;s perspective.</p><p>The physical memory, for all CPU designs, can always be modeled as a flat continuous byte array.
Ultimately, the CPU talks to the memory module through the memory bus, and the physical memory - the &ldquo;flat&rdquo; space can be scanned through by incrementing the numeric value on the address bus. There is no magic.</p><p>To access memory, the most intuitive way might be to store the physical address as part of a memory access instruction, which could be sent verbatim on the address bus. However, for most CPU models, the situation is more complicated than that.</p><h2 id=programming-with-physical-addresses>Programming with Physical Addresses</h2><p>Very early microprocessor models e.g. Intel 8080/8085, exposed this physical memory space directly to program instructions.</p><p>The 8080/8085 instruction set is encoded with at most 3 bytes.
The opcode and register specification is always 1 byte, leaving at most 2 bytes for immediate operands.
These models have 16 address lines, making it ideal to encode a memory address as an immediate operand.</p><p>Assembly code does one of the following when referring to a memory location:</p><ol><li><p>directly spell physical address as an immediate operand in the instruction.</p><p>This is either done by hardcoding an immediate number operand or using a label that is replaced with the computed address by the assembler.
Both methods generate the same code, but most times it is either impossible or meaningless for a programmer to compute an address and then hardcode it.</p><p>e.g. An <code>SHLD 0x0055</code> stores the content of the <code>HL</code> register pair to the physical memory address <code>0x0055</code>, or
a <code>JMP foo</code> jump to whatever address the label <code>foo</code> resolved to.</p></li><li><p>dereference a register (pair)</p><p>For memory addresses computed at runtime and stored in registers, dedicated instructions are used to provide read/write access.</p><p>The 8080/8085 has 16 address lines but its registers are 8 bits in width.
To address the whole memory space, registers <code>B</code> and <code>C</code>, <code>D</code> and <code>E</code>, <code>H</code> and <code>L</code>, are combined to form 3 16-bit register pairs.</p><p>For example, a <code>STAX [BC|DE|HL]</code> interprets the content of the given 16-bit register pair as an absolute physical address and
stores the value of the <code>A</code> register to that location.</p></li></ol><h2 id=80868088-segmentation-v1-and-why>8086/8088: Segmentation v1, and Why</h2><p>The 8086 and 8088 have 20 address pins supporting 1 MiB of physical memory, but their register is only 16 bits.
There is no virtual memory and paging yet, so we are still working with physical memory - the flat array - directly.</p><p>The instruction set was redesigned, which makes sense - obviously, nobody wanted to stick with the 1-byte encoding.
Again instructions can refer to memory locations either known at assemble time or must be computed at run time.</p><p>However this time, spelling absolute addresses as immediate operands simply didn&rsquo;t make its way into the new design:</p><ol><li><p>encoding a 20-bit immediate operand into an instruction will waste 4 bits per operand since instructions start on the byte boundary.</p></li><li><p>the static nature of the immediate operand makes it inflexible.</p><p>Remember there is no virtual paging yet, and a program with absolute addresses as immediate operands expects itself to be loaded at a specific memory location. Two such programs thus can&rsquo;t be loaded at the same time. Given the 1MiB memory which is considerably huge contemporarily, this is a waste of memory.</p></li><li><p>Meanwhile, everything that can be done with an absolute address immediate operand can be achieved by first loading the address into a register and then playing with that register.</p></li></ol><p>Intel designers can of course hack the design and still allow physical address as an immediate operand, but that would cost more circuitry
and bring more complexity into the design than wanted.</p><p>Anyway, absolute address immediate operands are gone forever.</p><h3 id=segmentation-v1>Segmentation v1</h3><p>Designers and programmers were facing a situation where they had to use 16-bit registers to address the 20-bit address space.
Instead of using the good old way inherited from 8080/8085 of concatenating 2 registers, a rather weird solution was devised,
known as memory segmentation:</p><ol><li><p>4 new registers were introduced, known as the segment registers: <code>CS / SS / DS / ES</code>.</p></li><li><p>Each instruction that accesses memory is associated with an implicit segment register.</p><p>For example, a <code>MOV</code> from/to memory is implicitly associated with <code>DS</code>.
Refer to the</p><p>Most such instructions also allow overriding the default segment with an instruction prefix.
e.g. <code>MOV AX, [4]</code> encodes to <code>a1 04 00</code> but <code>MOV AX, [CS:4]</code> encodes to <code>2e a1 04 00</code>; the <code>2e</code> prefix
tells the CPU to use the <code>CS</code> segment register instead of the default <code>DS</code> for <code>MOV</code>.</p><p>Also, note that different assemblers may allow different syntax for such segment override.
e.g. All of <code>CS MOV AX, [4]</code>, <code>CS MOV AX, [4]</code>, and <code>MOV AX, CS:[4]</code> generate identical instructions in NASM.</p></li><li><p>Each instruction that accesses memory can have at most 1 memory operand, i.e. a value from a memory location (instead of a register or immediate number).</p><p>Conceptually, the term <em>operand</em> refers to the value found at a given memory address, instead of the address itself.</p><p>Within an instruction, 3 components may be specified, all of which are optional but at least one must appear,
to instruct the CPU to uniquely locate this operand in memory:</p><ol><li>a base register: can be <code>BX</code> or <code>BP</code></li><li>an index register: can be <code>SI</code> or <code>DI</code></li><li>displacement: an immediate number</li></ol><p>In the ages of 80386 and before, the mix and match of the presence of the 3 components are summarized as the various addressing modes of x86.
Modern Intel SDM and AMD manuals deprecate the concepts and term of &ldquo;addressing mode&rdquo; since they make address computation more
complicated than it really is.</p><p>Just in case you wonder, there is no <code>scale</code> component for 8086 and 80286 - the <code>SIB</code> byte is first introduced in 80386.</p></li></ol><p>The physical address that will be made available on the address bus is computed as follows:</p><ol><li>During the decode phrase of an instruction, the execution unit (EU) computes <code>base + index + displacement</code>, whose result is known as the effective address (EA) of the memory operand.</li><li>EA is then made available on an internal bus connecting the EU and the BIU (bus interface unit).</li><li>The physical address (the bits sent over the 20-bit address bus) is calculated by the BIU as <code>((selected segment register) &lt;&lt; 4) + EA</code>. EA is also known as an offset from the segment base address.</li></ol><p>The arithmetic part looks like:</p><div class=codeblock-hook><pre tabindex=0><code>segment     4 5 0 0
EA            F C 3 2
-------------------------
phy         5 4 C 3 2</code></pre><button>copy</button></div><figure><img src=./8086addr.jpg></figure><p>Interested readers may refer to the Section 2.8 of the <em>8086 Family User&rsquo;s Manual (9800722-03, Oct 1979)</em> for details.</p><p>There is no exception to the rules above. No memory access could circumvent this <code>base + offset</code> arithmetic regardless of the syntax.</p><ul><li><p>Instructions like <code>MOV AX, [BX]</code> or <code>MOV AX, [40]</code> can be confusing to beginners as if they were absolute physical addresses if a reader doesn&rsquo;t know about the aforementioned segmentation mechanism.</p></li><li><p>The ambiguity of language sometimes makes it worse, e.g. Intel&rsquo;s 80386 manual when talking about the real (address) mode:</p><blockquote><p>In this mode of operation, all memory addressing is performed in terms of real physical addresses.</p></blockquote><p>which really means there is no virtual paging in real mode, and has nothing to do with using absolute physical address in instruction encoding.</p></li></ul><p>The consequences of such memory segmentation are:</p><ol><li>there are 4096 different combinations of <code>base + offset</code> to address any location in the physical memory.</li><li>Each segment is thus naturally aligned on a 16-byte boundary and is 64KiB in size.</li><li>Segments can thus be adjacent, disjoint, partially overlapped, or fully overlapped.</li></ol><h3 id=conclusion-80868088-memory-segmentation>Conclusion: 8086/8088 memory segmentation</h3><p>In retrospect, the biggest motivation for having segmentation at all is the insufficient register width.
Also, an implied segment base address reduces the size of each instruction,
since only the offset needs to be mentioned in each instruction.</p><p>The Intel folks actually <a href=https://stevemorse.org/8086history/8086history.doc>had a plan</a> for 8086
to use an 8-bit shift to the segment register instead of the 4-bit, but this would allow a 24-bit memory space,
which is considered too large for its time. This would have forced segments to begin on 256-byte boundaries, which is considered a waste in its time.</p><p>There has long been criticism against x86&rsquo;s segmentation solution. Memory segment is a weird solution indeed, and - as you can see - not all CPU designs need it - at least not those whose registers are wider than the address bus.</p><h2 id=80286-segmentation-v2>80286, Segmentation v2</h2><p>The Intel 80286 was released in 1982.
It still uses 16-bit registers, but the number of address lines increased to 24, supporting physical memory of up to 16 MiB.</p><p>2 modes of operations were introduced: Real Address Mode and Protected Virtual Address Mode.
Switching between the 2 modes is done by setting/unsetting the <code>Protected Enabled (PE)</code> bit in the <code>Machine Status Word (MSW)</code> register.
The 80286, upon reset, works in Real Address Mode by default.</p><h3 id=real-address-mode>Real Address Mode</h3><p>The real address mode, a.k.a real mode, simply captures how 8086/8088 works.
A program written for 8086/8088 can be run on an 80286 in the real address mode without any modification,
in which scenario the 80286 is essentially a high-performance 8086.</p><p>In the Real Address Mode:</p><ul><li>The 4 segment registers were still 16 bits.</li><li>The only noticeable difference is that there are indeed new instructions that didn&rsquo;t exist in 8086 and 80186 that can be executed in the real address mode of 80286.</li><li>the <code>A20 - A23</code> bits of the address bus should not be used by programs, though it doesn&rsquo;t hurt if those bits are not 0. The memory controller will ignore them and ensure <code>0</code>s are sent over the high 4 pins of the address bus, i.e. only the low 20-bit physical memory can be used.</li></ul><h3 id=protected-virtual-address-mode>Protected Virtual Address Mode</h3><p>Also known as the Protected Mode. 80286 didn&rsquo;t implement virutal memory paging, thus the protected mode of 80286
is still several steps away from the modern Protected Mode since 80386.</p><p>Here is how 80286 in Protected Mode works:</p><ol><li>General purpose registers are still 16 bits wide.</li><li>2 important memory-resident data structures, the Global Descriptor Table (GDT) and the Local Descriptor Table (LDT), are introduced</li><li>the 4 segment registers are now 64-bit registers. Instead of holding a base address before shift (as in the real mode), the high 16 bits are known as selectors, and the low 48 bits are used as cache and are not visible to programs in any way.</li></ol><p>A selector has the following format:</p><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 656 73"><g transform="translate(8,16)"><path d="M0 16H480" fill="none" stroke="currentcolor"/><path d="M0 48H480" fill="none" stroke="currentcolor"/><path d="M0 16V48" fill="none" stroke="currentcolor"/><path d="M480 16V48" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="0" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="8" y="4" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="32" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="40" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="48" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="56" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="64" y="36" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="80" y="36" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="88" y="36" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="96" y="36" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="112" y="36" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="120" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="128" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="136" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="144" y="36" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="256" y="36" fill="currentcolor" style="font-size:1em">|</text><text text-anchor="middle" x="272" y="36" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="280" y="36" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="296" y="36" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="304" y="36" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="320" y="36" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="328" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="336" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="344" y="36" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="360" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="360" y="36" fill="currentcolor" style="font-size:1em">|</text><text text-anchor="middle" x="376" y="36" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="384" y="36" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="392" y="36" fill="currentcolor" style="font-size:1em">L</text><text text-anchor="middle" x="408" y="36" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="416" y="36" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="432" y="36" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="440" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="448" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="456" y="36" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="480" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="520" y="36" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="528" y="36" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="536" y="36" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="544" y="36" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="552" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="560" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="576" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="584" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="592" y="36" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="600" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="608" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="616" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="624" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="632" y="36" fill="currentcolor" style="font-size:1em">r</text></g></svg></div><ul><li><code>index</code> is an index into either GDT or LDT, depending on the <code>TI</code> bit</li><li><code>RPL</code> is used for privilege ring separation. Privilege control is not the focus of this article. See <a href=https://cesun.info/cpu/x86/privilege/>x86 Privilege Model</a> for an discussion.</li></ul><p>For a complete view, GDT and LDT must be discussed first.</p><h3 id=global-descriptor-table-gdt>Global Descriptor Table (GDT)</h3><p>A new register, <code>GDTR</code> (Global Descriptor Table Register) is introduced.
It is a 40-bit register consisting of 2 components:</p><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 528 73"><g transform="translate(8,16)"><path d="M0 16H336" fill="none" stroke="currentcolor"/><path d="M0 48H336" fill="none" stroke="currentcolor"/><path d="M0 16V48" fill="none" stroke="currentcolor"/><path d="M336 16V48" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="8" y="4" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="16" y="4" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="16" y="36" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="24" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="32" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="40" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="36" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="64" y="36" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="72" y="36" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="88" y="36" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="96" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="104" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="112" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="120" y="36" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="192" y="36" fill="currentcolor" style="font-size:1em">|</text><text text-anchor="middle" x="200" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="208" y="4" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="208" y="36" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="216" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="224" y="36" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="232" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="240" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="256" y="36" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="264" y="36" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="272" y="36" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="288" y="36" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="296" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="304" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="312" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="320" y="36" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="352" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="416" y="36" fill="currentcolor" style="font-size:1em">G</text><text text-anchor="middle" x="424" y="36" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="432" y="36" fill="currentcolor" style="font-size:1em">T</text><text text-anchor="middle" x="440" y="36" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="456" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="464" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="472" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="480" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="488" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="496" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="504" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="512" y="36" fill="currentcolor" style="font-size:1em">r</text></g></svg></div><ol><li><p>base (bit 16 - 39): the 24-bit physical address where the GDT starts.</p></li><li><p>limit (bit 0 - 15): the size of the GDT in bytes minus 1.</p><p>The <code>-1</code> is because the max value of this field is 65535 while the GDT can be 65536 bytes in size.
Since each item of the GDT is 8 bytes, <code>limit + 1</code> is always a multiple of 8.</p></li></ol><p>The <code>GDTR</code> register is not accessible by ordinary data instructions. 2 dedicated instructions <code>LGDT</code> (load GDT) and <code>SGDT</code> (store GDT) are designed for that purpose, and should only be used during initialization of the Protected Mode. Subsequent alteration of the GDTR register is not recommended, though possible at the Ring 0 privilege level.</p><p><code>GDTR</code> locates a region in the memory called the Global Descriptor Table (GDT), which is a list of <em>descriptors</em>.
There are 2 types of descriptors:</p><ul><li>A segment descriptor is marked by the <code>S=1</code> bit, and describes a piece of continuous memory known as a segment, that contains code or data of some program.</li><li>Other descriptors have <code>S=0</code> and locate various data structures the CPU is aware of. Also note that <code>TYPE</code> field is 4 bits and the <code>A</code> flag is gone.</li></ul><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 704 169"><g transform="translate(8,16)"><path d="M0 16H32" fill="none" stroke="currentcolor"/><path d="M32 16H64" fill="none" stroke="currentcolor"/><path d="M64 16H96" fill="none" stroke="currentcolor"/><path d="M96 16h32" fill="none" stroke="currentcolor"/><path d="M128 16h32" fill="none" stroke="currentcolor"/><path d="M160 16h32" fill="none" stroke="currentcolor"/><path d="M192 16h32" fill="none" stroke="currentcolor"/><path d="M224 16h32" fill="none" stroke="currentcolor"/><path d="M256 16h32" fill="none" stroke="currentcolor"/><path d="M288 16h32" fill="none" stroke="currentcolor"/><path d="M320 16h32" fill="none" stroke="currentcolor"/><path d="M352 16h32" fill="none" stroke="currentcolor"/><path d="M384 16h32" fill="none" stroke="currentcolor"/><path d="M416 16h32" fill="none" stroke="currentcolor"/><path d="M448 16h32" fill="none" stroke="currentcolor"/><path d="M0 48H32" fill="none" stroke="currentcolor"/><path d="M32 48H64" fill="none" stroke="currentcolor"/><path d="M64 48H96" fill="none" stroke="currentcolor"/><path d="M96 48h32" fill="none" stroke="currentcolor"/><path d="M128 48h32" fill="none" stroke="currentcolor"/><path d="M160 48h32" fill="none" stroke="currentcolor"/><path d="M192 48h32" fill="none" stroke="currentcolor"/><path d="M224 48h32" fill="none" stroke="currentcolor"/><path d="M256 48h32" fill="none" stroke="currentcolor"/><path d="M288 48h32" fill="none" stroke="currentcolor"/><path d="M320 48h32" fill="none" stroke="currentcolor"/><path d="M352 48h32" fill="none" stroke="currentcolor"/><path d="M384 48h32" fill="none" stroke="currentcolor"/><path d="M416 48h32" fill="none" stroke="currentcolor"/><path d="M448 48h32" fill="none" stroke="currentcolor"/><path d="M0 80H32" fill="none" stroke="currentcolor"/><path d="M32 80H64" fill="none" stroke="currentcolor"/><path d="M64 80H96" fill="none" stroke="currentcolor"/><path d="M96 80h32" fill="none" stroke="currentcolor"/><path d="M128 80h32" fill="none" stroke="currentcolor"/><path d="M160 80h32" fill="none" stroke="currentcolor"/><path d="M192 80h32" fill="none" stroke="currentcolor"/><path d="M224 80h32" fill="none" stroke="currentcolor"/><path d="M256 80h32" fill="none" stroke="currentcolor"/><path d="M288 80h32" fill="none" stroke="currentcolor"/><path d="M320 80h32" fill="none" stroke="currentcolor"/><path d="M352 80h32" fill="none" stroke="currentcolor"/><path d="M384 80h32" fill="none" stroke="currentcolor"/><path d="M416 80h32" fill="none" stroke="currentcolor"/><path d="M448 80h32" fill="none" stroke="currentcolor"/><path d="M0 112H32" fill="none" stroke="currentcolor"/><path d="M32 112H64" fill="none" stroke="currentcolor"/><path d="M64 112H96" fill="none" stroke="currentcolor"/><path d="M96 112h32" fill="none" stroke="currentcolor"/><path d="M128 112h32" fill="none" stroke="currentcolor"/><path d="M160 112h32" fill="none" stroke="currentcolor"/><path d="M192 112h32" fill="none" stroke="currentcolor"/><path d="M224 112h32" fill="none" stroke="currentcolor"/><path d="M256 112h32" fill="none" stroke="currentcolor"/><path d="M288 112h32" fill="none" stroke="currentcolor"/><path d="M320 112h32" fill="none" stroke="currentcolor"/><path d="M352 112h32" fill="none" stroke="currentcolor"/><path d="M384 112h32" fill="none" stroke="currentcolor"/><path d="M416 112h32" fill="none" stroke="currentcolor"/><path d="M448 112h32" fill="none" stroke="currentcolor"/><path d="M0 144H32" fill="none" stroke="currentcolor"/><path d="M32 144H64" fill="none" stroke="currentcolor"/><path d="M64 144H96" fill="none" stroke="currentcolor"/><path d="M96 144h32" fill="none" stroke="currentcolor"/><path d="M128 144h32" fill="none" stroke="currentcolor"/><path d="M160 144h32" fill="none" stroke="currentcolor"/><path d="M192 144h32" fill="none" stroke="currentcolor"/><path d="M224 144h32" fill="none" stroke="currentcolor"/><path d="M256 144h32" fill="none" stroke="currentcolor"/><path d="M288 144h32" fill="none" stroke="currentcolor"/><path d="M320 144h32" fill="none" stroke="currentcolor"/><path d="M352 144h32" fill="none" stroke="currentcolor"/><path d="M384 144h32" fill="none" stroke="currentcolor"/><path d="M416 144h32" fill="none" stroke="currentcolor"/><path d="M448 144h32" fill="none" stroke="currentcolor"/><path d="M0 16V48" fill="none" stroke="currentcolor"/><path d="M0 48V80" fill="none" stroke="currentcolor"/><path d="M0 80v32" fill="none" stroke="currentcolor"/><path d="M0 112v32" fill="none" stroke="currentcolor"/><path d="M96 48V80" fill="none" stroke="currentcolor"/><path d="M128 48V80" fill="none" stroke="currentcolor"/><path d="M256 48V80" fill="none" stroke="currentcolor"/><path d="M480 16V48" fill="none" stroke="currentcolor"/><path d="M480 48V80" fill="none" stroke="currentcolor"/><path d="M480 80v32" fill="none" stroke="currentcolor"/><path d="M480 112v32" fill="none" stroke="currentcolor"/><path d="M536 16V144" fill="none" stroke="currentcolor"/><polygon points="544.000000,16.000000 532.000000,10.400000 532.000000,21.600000" fill="currentcolor" transform="rotate(270.000000, 536.000000, 16.000000)"/><text text-anchor="middle" x="16" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="16" y="36" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="16" y="100" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="16" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="24" y="4" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="24" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="24" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="24" y="132" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="32" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="32" y="100" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="32" y="132" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="40" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="40" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="40" y="132" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="48" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="48" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="48" y="132" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="56" y="4" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="56" y="36" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="56" y="100" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="64" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="64" y="100" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="64" y="132" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="72" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="72" y="132" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="80" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="80" y="100" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="88" y="4" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="88" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="88" y="132" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="96" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="96" y="100" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="104" y="68" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="104" y="132" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="112" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="112" y="36" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="112" y="68" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="120" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="120" y="36" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="120" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="128" y="36" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="136" y="36" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="144" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="144" y="36" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="152" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="152" y="36" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="168" y="36" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="176" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="176" y="36" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="184" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="184" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="192" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="208" y="4" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="208" y="36" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="216" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="232" y="36" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="240" y="4" fill="currentcolor" style="font-size:1em">8</text><text text-anchor="middle" x="240" y="36" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="272" y="4" fill="currentcolor" style="font-size:1em">7</text><text text-anchor="middle" x="272" y="68" fill="currentcolor" style="font-size:1em">B</text><text text-anchor="middle" x="280" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="288" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="296" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="304" y="4" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="312" y="68" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="320" y="68" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="336" y="4" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="336" y="68" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="352" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="360" y="68" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="368" y="4" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="400" y="4" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="432" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="464" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="504" y="36" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="504" y="68" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="504" y="100" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="504" y="132" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="552" y="84" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="560" y="84" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="568" y="84" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="576" y="84" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="584" y="84" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="592" y="84" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="600" y="84" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="608" y="84" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="616" y="84" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="624" y="84" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="640" y="84" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="648" y="84" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="656" y="84" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="664" y="84" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="672" y="84" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="680" y="84" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="688" y="84" fill="currentcolor" style="font-size:1em">s</text></g></svg></div><p>Regardless of the descriptor types:</p><ol><li>limit (16-bit): the size of the segment, in bytes,</li><li>base (24-bit): the base address of the segment. There is no paging in 80286, so this is the real 24-bit physical address, no shifting.</li><li>The 6th byte is known as the access byte. We won&rsquo;t dig into this byte other than the <code>S</code> bit, since the definition of this byte changes slightly in later models.</li></ol><p>The first entry in the GDT must be filled with 0, indicating an invalid descriptor.</p><p>Pause for a moment and notice the re-occurrence of the term <em>segment</em>. Segment, in Protected Mode of 80286, still refers to a piece of continuous memory, but its base address is now stored in a descriptor instead of directly in the segment register, and its size can vary.</p><h3 id=local-descriptor-table-ldt>Local Descriptor Table (LDT)</h3><p>A Local Descriptor Table (LDT) is the task-specific counterpart of GDT.</p><div class="card info"><div class=card-icon><span>ℹ️</span></div><div class=card-content><p><a href=https://cesun.info/cpu/x86/task/>Multi-tasking / context switching is implemented by 80286 and later 32-bit x86 CPUs at the hardware level</a>.
A series of task-specific registers were introduced, including the <code>Task Register (TR)</code> and <code>LDT Register (LDTR)</code>, which are automatically
reloaded upon a task switch.</p><p>However, making the CPU hardware to be task-aware turned out to be a bad idea, in terms of both performance and portability.
x86_64 CPUs when running in 64-bit mode disable hardware context switching completely, and ask the OS kernel to implement context switching by software.</p></div></div><p>Each task has its own LDT, meaning that there will be multiple LDTs across the memory of the whole system,
while there is only a unique GDT shared by all tasks. An LDT has an identical structure to the GDT, except that its first entry is also a valid descriptor.</p><p>The LDT of a task is located by the 64-bit <code>LDTR</code> register whose high 16 bits hold a selector.
The selector selects a descriptor in the GDT that has <code>S=0</code> (system segment) and has its <code>base</code> and <code>limit</code> mark a memory region holding the LDT of that task. Again, the low 48 bits is used as a cache that stores the critical part of the selected descriptor.</p><p>The <code>LDTR</code> register is only accessible via 2 special instructions <code>SLDT - store LDT(R)</code> and <code>LLDT - load LDT(R)</code>.
When context switching occurs, the content of this register will also be automatically altered to reflect the location and size of the LDT of the active task.</p><h3 id=segment-registers>segment registers</h3><p>As discussed in the previous 2 sections, at any time during the run of a program, 2 descriptor tables are accessible.</p><p>The 4 segment registers, <code>CS / SS / DS / ES</code>, once 16-bit registers holding real in real mode, are now each 64-bit registers in the Protected Mode, all of which have the following format:</p><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 792 73"><g transform="translate(8,16)"><path d="M0 16H768" fill="none" stroke="currentcolor"/><path d="M0 48H768" fill="none" stroke="currentcolor"/><path d="M0 16V48" fill="none" stroke="currentcolor"/><path d="M288 24V40" fill="none" stroke="currentcolor"/><path d="M768 16V48" fill="none" stroke="currentcolor"/><path d="M288 24v8" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="8" y="4" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="16" y="4" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="32" y="36" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="40" y="36" fill="currentcolor" style="font-size:1em">6</text><text text-anchor="middle" x="48" y="36" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="56" y="36" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="64" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="72" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="88" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="96" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="104" y="36" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="112" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="120" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="128" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="136" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="144" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="192" y="36" fill="currentcolor" style="font-size:1em">|</text><text text-anchor="middle" x="200" y="4" fill="currentcolor" style="font-size:1em">4</text><text text-anchor="middle" x="208" y="4" fill="currentcolor" style="font-size:1em">7</text><text text-anchor="middle" x="208" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="216" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="224" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="232" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="240" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="248" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="296" y="4" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="304" y="4" fill="currentcolor" style="font-size:1em">9</text><text text-anchor="middle" x="312" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="320" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="328" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="336" y="36" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="344" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="352" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="360" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="376" y="36" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="384" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="392" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="400" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="416" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="424" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="432" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="440" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="448" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="456" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="464" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="576" y="36" fill="currentcolor" style="font-size:1em">|</text><text text-anchor="middle" x="584" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="592" y="4" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="592" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="600" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="608" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="616" y="36" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="624" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="632" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="640" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="656" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="664" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="672" y="36" fill="currentcolor" style="font-size:1em">z</text><text text-anchor="middle" x="680" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="776" y="4" fill="currentcolor" style="font-size:1em">0</text></g></svg></div><p>Only the selector part (i.e. the most significant 16 bits) is visible to programmers.
There is no way the low 48 bits can be accessed by a program, not even in ring 0.</p><ul><li>A read from a segment register, e.g. <code>MOV AX, DS</code> moves only the selector part of <code>DS</code> into <code>AX</code>.</li><li>When a write to a segment register occurs, due to either explicit data instructions like <code>MOV</code> or <code>POP</code> etc. or inter-segment <code>JMP</code> / <code>CALL</code> which implicitly changes the <code>CS</code>, the instruction only needs to specify the selector part of the segment register. Given a selector with a 14-bit <code>index</code> and a <code>TI</code> bit, the CPU will automatically load the lower 48 bits (6 bytes) from the beginning of the <code>index</code>-th entry of</li><li>the GDT, if <code>TI</code> is 0</li><li>the Local Descriptor Table (LDT), if <code>TI</code> is 1</li></ul><p>and ignore the high 2 reserved bytes. Caching the descriptor in the register accelerates future access by eliminating the need for bus cycles.</p><div class="card info"><div class=card-icon><span>ℹ️</span></div><div class=card-content><p>The <code>index</code> of a segment selector loaded into a segment register might be 0, and in the case of <code>TI=0</code>, this indicates the invalid entry
at the beginning of the GDT. Such a selector is known as the null selector.</p><p>Loading the null selector into</p><ol><li><p>CS or SS register causes a general-protection exception (#GP)</p></li><li><p>DS, ES (and for later FS and GS) does not trigger a CPU exception per se.</p><p>The exception occurs when trying to access an offset within this invalid segment. This can be used as a technique to initialize unused data segment registers and check unintentional memory access in code.</p></li></ol></div></div><h3 id=conclusion-80286-segmentation-without-virtual-paging>Conclusion: 80286, segmentation without virtual paging</h3><p>80286 and later 32-bit x86 has one more table / register pair, the Interrupt Descriptor Table (IDT) and <code>IDTR</code> (IDT Register), which is not of importance for the topic of memory. See <a href=https://cesun.info/cpu/x86/task/>x86 / x86_64 Task Management</a> for details.</p><h2 id=since-80386-segmentation--virtual-paging>Since 80386: Segmentation + Virtual Paging</h2><p>Welcome to the age of 32-bit x86, 1986. The first platform Linux ran on. The following discussion applies to 80386 and all later x86 model, and x86_64 models that run in 32-bit mode.</p><p>There are now 3 CPU operation modes:</p><ol><li>real address mode: Nothing new here. x86 behaves like a fast 8086 with some new instructions. Programs for 8086 can be run without modification.</li><li>protected mode: among other improvements, 80386 adds virtual memory paging to 80286&rsquo;s protected mode</li><li>virtual 8086 mode: With the help of the OS, this mode allows a program written for 8086 to run as a protected-mode process, without affecting other processes running in protected mode on the same system.</li></ol><h3 id=protected-mode-refurbished>Protected Mode, Refurbished</h3><p>Improvements / Changes from the Protected Mode of 80286 are:</p><ol><li>All general-purpose registers are 32-bit in the protected mode.</li><li>The address bus is widened to 32-bit, meaning that the old way of <code>16-bit EA</code> + <code>24-bit segment base</code> to generate a 24-bit physical address is not enough; this is not a problem, see below.</li><li>a new <code>SIB</code> byte was introduced into the 32-bit protected mode instruction encoding.</li><li>The once reserved high 2 bytes in descriptor in LDT and GDT is now used to store extra base bits and certain flags. Now segment base is 32-bit wide.</li><li>virtual memory paging can be turned on by setting the <code>PG</code> bit of the <code>CR0</code> (Control Register 0).</li></ol><p>Forget about paging for a moment. The consequences are that in 32-bit protected mode:</p><ol><li><p>the new registers are of the same width as the address bus, rendering the whole idea of segmentation pointless. For compatibility, the segmentation mechanics are still preserved, and in normal situations, all segment registers are set to 0 by the OS.</p><p><a href=https://stackoverflow.com/questions/15335003/what-is-the-purpose-of-segment-registers-in-x86-protected-mode>https://stackoverflow.com/questions/15335003/what-is-the-purpose-of-segment-registers-in-x86-protected-mode</a></p></li><li><p>The presence of <code>SIB</code> byte is indicated by <code>ModR/M.Mod != 11 && ModR/M.R/M == 100</code>.
This byte specifies a <code>scaling factor</code> (2 bits), an <code>index register</code> (3 bits), and a <code>base register</code> (3 bits)
such that the effective address of a memory operand can now be specified as <code>base register + index register * one of(1,2,4,8) + displacement</code>, known as SIB-based addressing. The introduction of this addressing feature makes array manipulation easier, but doesn&rsquo;t itself changes the memory organization.</p></li></ol><h4 id=paging>Paging</h4><p>When paging is turned on, the physical memory address space is divided into 4KiB pages.
(forget about 4MiB-page for now)</p><p>2 more types of memory-resident structures are introduced.
An instance of either structure itself lives on a page, i.e. starting on a 4KiB boundary.
When its physical address needs to be stored, only the high 20 bits are needed, since the low 12 bits are always 0.</p><ul><li><p>The page directory is an array of 32-bit entries of the following format:</p><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 656 89"><g transform="translate(8,16)"><path d="M0 16H104" fill="none" stroke="currentcolor"/><path d="M104 16H208" fill="none" stroke="currentcolor"/><path d="M208 16H312" fill="none" stroke="currentcolor"/><path d="M312 16H416" fill="none" stroke="currentcolor"/><path d="M0 48H104" fill="none" stroke="currentcolor"/><path d="M104 48H208" fill="none" stroke="currentcolor"/><path d="M208 48H312" fill="none" stroke="currentcolor"/><path d="M312 48H416" fill="none" stroke="currentcolor"/><path d="M0 16V48" fill="none" stroke="currentcolor"/><path d="M408 24V40" fill="none" stroke="currentcolor"/><path d="M408 24v8" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="0" y="4" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="8" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="16" y="36" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="24" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="32" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="40" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="64" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="72" y="36" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="80" y="36" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="88" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="104" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="104" y="36" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="112" y="4" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="112" y="36" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="120" y="36" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="136" y="36" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="144" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="152" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="160" y="36" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="176" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="184" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="192" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="200" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="208" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="216" y="4" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="224" y="36" fill="currentcolor" style="font-size:1em">|</text><text text-anchor="middle" x="224" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="232" y="68" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="240" y="36" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="248" y="36" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="256" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="264" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="272" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="312" y="4" fill="currentcolor" style="font-size:1em">7</text><text text-anchor="middle" x="424" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="472" y="36" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="480" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="488" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="496" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="512" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="520" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="528" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="536" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="544" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="552" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="560" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="568" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="576" y="36" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="592" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="600" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="608" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="616" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="624" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="632" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="640" y="36" fill="currentcolor" style="font-size:1em">s</text></g></svg></div><ul><li>The high 20 bits store the high 20 bits of the physical address of a page table.</li><li>The low 12 bits are either flag bits indicating some properties of the identified page table, or ignored.</li></ul><p>There is only 1 unique page directory in the whole system.
The high 20 bits of the physical address of the page directory are stored in the high 20 bits of the <code>CR3</code> register (which is 32-bit).</p><p>Since the page directory itself lives on a 4K page, the maximum number of entries is 1024.</p></li><li><p>a page table is also an array of 32-bit entries of the following format:</p><div class="goat svg-container"><svg font-family="Menlo,Lucida Console,monospace" viewBox="0 0 632 89"><g transform="translate(8,16)"><path d="M0 16H104" fill="none" stroke="currentcolor"/><path d="M104 16H208" fill="none" stroke="currentcolor"/><path d="M208 16H312" fill="none" stroke="currentcolor"/><path d="M312 16H416" fill="none" stroke="currentcolor"/><path d="M0 48H104" fill="none" stroke="currentcolor"/><path d="M104 48H208" fill="none" stroke="currentcolor"/><path d="M208 48H312" fill="none" stroke="currentcolor"/><path d="M312 48H416" fill="none" stroke="currentcolor"/><path d="M0 16V48" fill="none" stroke="currentcolor"/><path d="M416 16V48" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="0" y="4" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="8" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="16" y="36" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="24" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="32" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="40" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="36" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="64" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="72" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="80" y="36" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="88" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="104" y="4" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="104" y="36" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="112" y="4" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="112" y="36" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="120" y="36" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="136" y="36" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="144" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="152" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="160" y="36" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="176" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="184" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="192" y="36" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="200" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="208" y="4" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="216" y="4" fill="currentcolor" style="font-size:1em">5</text><text text-anchor="middle" x="224" y="36" fill="currentcolor" style="font-size:1em">|</text><text text-anchor="middle" x="224" y="68" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="232" y="68" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="240" y="36" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="248" y="36" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="256" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="264" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="272" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="312" y="4" fill="currentcolor" style="font-size:1em">7</text><text text-anchor="middle" x="424" y="4" fill="currentcolor" style="font-size:1em">0</text><text text-anchor="middle" x="480" y="36" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="488" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="496" y="36" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="504" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="520" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="528" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="536" y="36" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="544" y="36" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="552" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="568" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="576" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="584" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="592" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="600" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="608" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="616" y="36" fill="currentcolor" style="font-size:1em">s</text></g></svg></div><ul><li>The high 20 bits store the high 20 bits of the physical address of a (application) page.</li><li>The low 12 bits are either flag bits indicating some properties of the identified page table, or ignored. Despite being similar to
entries of the page directory, the semantics of flag bits differ. Readers should refer to Intel SDM for details.</li></ul></li></ul><p>With the CPU working in the protected mode and paging turned on, the physical address of a memory operand is derived in the following way:</p><ol><li><p>the effective address (EA) is still computed first. Depending on the value of <code>ModRM</code> and <code>SIB</code> bytes, one of the following mix-and-match will be used:</p><figure><img src=/cpu/x86/memory/ea.png alt="All possible mix-and-match of EA computation methods."><figcaption><p>All possible mix-and-match of EA computation methods.</p></figcaption></figure></li><li><p>The relevant segment register is inspected, which is either the default one associated with the instruction or one explicitly overridden by an instruction prefix. The selector in that segment register selects a descriptor in LDT or GDT, which describes a region in the <em>linear address space</em>, i.e. the segment.</p></li><li><p>The EA is added to the 32-bit segment base to form a 32-bit address in the linear address space.</p></li><li><p>This linear address is divided into 3 parts.</p><ul><li>high 10 bits: <code>DIR</code>. This 10-bit integer is used as an index into the page directory to select an entry which refers a page table.</li><li>middle 10 bits: <code>PAGE</code>. In the referred page table, this 10-bit integer is used as an index and selects an entry. This entry has the physical address of a page frame, i.e. where the page starts.</li><li>low 12 bits: <code>offset</code>. Add <code>offset</code> to the physical address of the page frame to get resulting the physical address.</li></ul></li></ol><figure><img src=/cpu/x86/memory/seg-n-paging.png></figure></div></article></main><footer>Unless otherwise noted, content of this site is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ style=text-decoration:underline>the CC BY-NC-SA 4.0</a>.<br>cesun.info copyright 2024.</footer></body></html>