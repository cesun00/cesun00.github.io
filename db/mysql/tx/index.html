<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>MySQL Transaction | Infinity Architect</title>
<link rel=stylesheet href=/main.css><script type=importmap>
  {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.167.1/+esm"
      }
  }
  </script><script type=module src=/theme.mjs></script><style>.tag-android{background-color:hsl(0deg 80% 70%)}.dark .tag-android{background-color:hsl(0deg 80% 20%)}.tag-annotation{background-color:hsl(50deg 80% 70%)}.dark .tag-annotation{background-color:hsl(50deg 80% 20%)}.tag-assembly{background-color:hsl(100deg 80% 70%)}.dark .tag-assembly{background-color:hsl(100deg 80% 20%)}.tag-asymmetrical-cryptography{background-color:hsl(150deg 80% 70%)}.dark .tag-asymmetrical-cryptography{background-color:hsl(150deg 80% 20%)}.tag-awk{background-color:hsl(200deg 80% 70%)}.dark .tag-awk{background-color:hsl(200deg 80% 20%)}.tag-bootloader{background-color:hsl(250deg 80% 70%)}.dark .tag-bootloader{background-color:hsl(250deg 80% 20%)}.tag-bytecode{background-color:hsl(300deg 80% 70%)}.dark .tag-bytecode{background-color:hsl(300deg 80% 20%)}.tag-c{background-color:hsl(350deg 80% 70%)}.dark .tag-c{background-color:hsl(350deg 80% 20%)}.tag-cxx{background-color:hsl(40deg 80% 70%)}.dark .tag-cxx{background-color:hsl(40deg 80% 20%)}.tag-cxx-stl{background-color:hsl(90deg 80% 70%)}.dark .tag-cxx-stl{background-color:hsl(90deg 80% 20%)}.tag-cgroup{background-color:hsl(140deg 80% 70%)}.dark .tag-cgroup{background-color:hsl(140deg 80% 20%)}.tag-cheetsheet{background-color:hsl(190deg 80% 70%)}.dark .tag-cheetsheet{background-color:hsl(190deg 80% 20%)}.tag-clang{background-color:hsl(240deg 80% 70%)}.dark .tag-clang{background-color:hsl(240deg 80% 20%)}.tag-coding-theory{background-color:hsl(290deg 80% 70%)}.dark .tag-coding-theory{background-color:hsl(290deg 80% 20%)}.tag-compression{background-color:hsl(340deg 80% 70%)}.dark .tag-compression{background-color:hsl(340deg 80% 20%)}.tag-concept{background-color:hsl(30deg 80% 70%)}.dark .tag-concept{background-color:hsl(30deg 80% 20%)}.tag-cpu{background-color:hsl(80deg 80% 70%)}.dark .tag-cpu{background-color:hsl(80deg 80% 20%)}.tag-crawler{background-color:hsl(130deg 80% 70%)}.dark .tag-crawler{background-color:hsl(130deg 80% 20%)}.tag-cryptography{background-color:hsl(180deg 80% 70%)}.dark .tag-cryptography{background-color:hsl(180deg 80% 20%)}.tag-css{background-color:hsl(230deg 80% 70%)}.dark .tag-css{background-color:hsl(230deg 80% 20%)}.tag-database{background-color:hsl(280deg 80% 70%)}.dark .tag-database{background-color:hsl(280deg 80% 20%)}.tag-deflate{background-color:hsl(330deg 80% 70%)}.dark .tag-deflate{background-color:hsl(330deg 80% 20%)}.tag-design{background-color:hsl(20deg 80% 70%)}.dark .tag-design{background-color:hsl(20deg 80% 20%)}.tag-dns{background-color:hsl(70deg 80% 70%)}.dark .tag-dns{background-color:hsl(70deg 80% 20%)}.tag-dom{background-color:hsl(120deg 80% 70%)}.dark .tag-dom{background-color:hsl(120deg 80% 20%)}.tag-driver{background-color:hsl(170deg 80% 70%)}.dark .tag-driver{background-color:hsl(170deg 80% 20%)}.tag-elastic{background-color:hsl(220deg 80% 70%)}.dark .tag-elastic{background-color:hsl(220deg 80% 20%)}.tag-elf{background-color:hsl(270deg 80% 70%)}.dark .tag-elf{background-color:hsl(270deg 80% 20%)}.tag-elk{background-color:hsl(320deg 80% 70%)}.dark .tag-elk{background-color:hsl(320deg 80% 20%)}.tag-flex{background-color:hsl(10deg 80% 70%)}.dark .tag-flex{background-color:hsl(10deg 80% 20%)}.tag-gc{background-color:hsl(60deg 80% 70%)}.dark .tag-gc{background-color:hsl(60deg 80% 20%)}.tag-gcc{background-color:hsl(110deg 80% 70%)}.dark .tag-gcc{background-color:hsl(110deg 80% 20%)}.tag-gnu{background-color:hsl(160deg 80% 70%)}.dark .tag-gnu{background-color:hsl(160deg 80% 20%)}.tag-go{background-color:hsl(210deg 80% 70%)}.dark .tag-go{background-color:hsl(210deg 80% 20%)}.tag-gzip{background-color:hsl(260deg 80% 70%)}.dark .tag-gzip{background-color:hsl(260deg 80% 20%)}.tag-hash{background-color:hsl(310deg 80% 70%)}.dark .tag-hash{background-color:hsl(310deg 80% 20%)}.tag-http{background-color:hsl(0deg 80% 70%)}.dark .tag-http{background-color:hsl(0deg 80% 20%)}.tag-huffman{background-color:hsl(50deg 80% 70%)}.dark .tag-huffman{background-color:hsl(50deg 80% 20%)}.tag-java{background-color:hsl(100deg 80% 70%)}.dark .tag-java{background-color:hsl(100deg 80% 20%)}.tag-java-module{background-color:hsl(150deg 80% 70%)}.dark .tag-java-module{background-color:hsl(150deg 80% 20%)}.tag-javascript{background-color:hsl(200deg 80% 70%)}.dark .tag-javascript{background-color:hsl(200deg 80% 20%)}.tag-jdk{background-color:hsl(250deg 80% 70%)}.dark .tag-jdk{background-color:hsl(250deg 80% 20%)}.tag-js{background-color:hsl(300deg 80% 70%)}.dark .tag-js{background-color:hsl(300deg 80% 20%)}.tag-jvm{background-color:hsl(350deg 80% 70%)}.dark .tag-jvm{background-color:hsl(350deg 80% 20%)}.tag-kernel{background-color:hsl(40deg 80% 70%)}.dark .tag-kernel{background-color:hsl(40deg 80% 20%)}.tag-lexer{background-color:hsl(90deg 80% 70%)}.dark .tag-lexer{background-color:hsl(90deg 80% 20%)}.tag-linux{background-color:hsl(140deg 80% 70%)}.dark .tag-linux{background-color:hsl(140deg 80% 20%)}.tag-log4j2{background-color:hsl(190deg 80% 70%)}.dark .tag-log4j2{background-color:hsl(190deg 80% 20%)}.tag-lz77{background-color:hsl(240deg 80% 70%)}.dark .tag-lz77{background-color:hsl(240deg 80% 20%)}.tag-make{background-color:hsl(290deg 80% 70%)}.dark .tag-make{background-color:hsl(290deg 80% 20%)}.tag-makefile{background-color:hsl(340deg 80% 70%)}.dark .tag-makefile{background-color:hsl(340deg 80% 20%)}.tag-maven{background-color:hsl(30deg 80% 70%)}.dark .tag-maven{background-color:hsl(30deg 80% 20%)}.tag-memory{background-color:hsl(80deg 80% 70%)}.dark .tag-memory{background-color:hsl(80deg 80% 20%)}.tag-multithreading{background-color:hsl(130deg 80% 70%)}.dark .tag-multithreading{background-color:hsl(130deg 80% 20%)}.tag-mybatis{background-color:hsl(180deg 80% 70%)}.dark .tag-mybatis{background-color:hsl(180deg 80% 20%)}.tag-mysql{background-color:hsl(230deg 80% 70%)}.dark .tag-mysql{background-color:hsl(230deg 80% 20%)}.tag-nasm{background-color:hsl(280deg 80% 70%)}.dark .tag-nasm{background-color:hsl(280deg 80% 20%)}.tag-node{background-color:hsl(330deg 80% 70%)}.dark .tag-node{background-color:hsl(330deg 80% 20%)}.tag-nodejs{background-color:hsl(20deg 80% 70%)}.dark .tag-nodejs{background-color:hsl(20deg 80% 20%)}.tag-openssl{background-color:hsl(70deg 80% 70%)}.dark .tag-openssl{background-color:hsl(70deg 80% 20%)}.tag-playwright{background-color:hsl(120deg 80% 70%)}.dark .tag-playwright{background-color:hsl(120deg 80% 20%)}.tag-posix{background-color:hsl(170deg 80% 70%)}.dark .tag-posix{background-color:hsl(170deg 80% 20%)}.tag-powershell{background-color:hsl(220deg 80% 70%)}.dark .tag-powershell{background-color:hsl(220deg 80% 20%)}.tag-programming-langauge{background-color:hsl(270deg 80% 70%)}.dark .tag-programming-langauge{background-color:hsl(270deg 80% 20%)}.tag-programming-language{background-color:hsl(320deg 80% 70%)}.dark .tag-programming-language{background-color:hsl(320deg 80% 20%)}.tag-qemu{background-color:hsl(10deg 80% 70%)}.dark .tag-qemu{background-color:hsl(10deg 80% 20%)}.tag-redis{background-color:hsl(60deg 80% 70%)}.dark .tag-redis{background-color:hsl(60deg 80% 20%)}.tag-retrocomputing{background-color:hsl(110deg 80% 70%)}.dark .tag-retrocomputing{background-color:hsl(110deg 80% 20%)}.tag-rfc{background-color:hsl(160deg 80% 70%)}.dark .tag-rfc{background-color:hsl(160deg 80% 20%)}.tag-sdram{background-color:hsl(210deg 80% 70%)}.dark .tag-sdram{background-color:hsl(210deg 80% 20%)}.tag-sed{background-color:hsl(260deg 80% 70%)}.dark .tag-sed{background-color:hsl(260deg 80% 20%)}.tag-slf4j{background-color:hsl(310deg 80% 70%)}.dark .tag-slf4j{background-color:hsl(310deg 80% 20%)}.tag-spring{background-color:hsl(0deg 80% 70%)}.dark .tag-spring{background-color:hsl(0deg 80% 20%)}.tag-spring-boot{background-color:hsl(50deg 80% 70%)}.dark .tag-spring-boot{background-color:hsl(50deg 80% 20%)}.tag-spring-data{background-color:hsl(100deg 80% 70%)}.dark .tag-spring-data{background-color:hsl(100deg 80% 20%)}.tag-spring-ioc{background-color:hsl(150deg 80% 70%)}.dark .tag-spring-ioc{background-color:hsl(150deg 80% 20%)}.tag-sql{background-color:hsl(200deg 80% 70%)}.dark .tag-sql{background-color:hsl(200deg 80% 20%)}.tag-streaming{background-color:hsl(250deg 80% 70%)}.dark .tag-streaming{background-color:hsl(250deg 80% 20%)}.tag-template{background-color:hsl(300deg 80% 70%)}.dark .tag-template{background-color:hsl(300deg 80% 20%)}.tag-testing{background-color:hsl(350deg 80% 70%)}.dark .tag-testing{background-color:hsl(350deg 80% 20%)}.tag-thymeleaf{background-color:hsl(40deg 80% 70%)}.dark .tag-thymeleaf{background-color:hsl(40deg 80% 20%)}.tag-tls{background-color:hsl(90deg 80% 70%)}.dark .tag-tls{background-color:hsl(90deg 80% 20%)}.tag-tomcat{background-color:hsl(140deg 80% 70%)}.dark .tag-tomcat{background-color:hsl(140deg 80% 20%)}.tag-transaction{background-color:hsl(190deg 80% 70%)}.dark .tag-transaction{background-color:hsl(190deg 80% 20%)}.tag-transistor{background-color:hsl(240deg 80% 70%)}.dark .tag-transistor{background-color:hsl(240deg 80% 20%)}.tag-ts{background-color:hsl(290deg 80% 70%)}.dark .tag-ts{background-color:hsl(290deg 80% 20%)}.tag-typescript{background-color:hsl(340deg 80% 70%)}.dark .tag-typescript{background-color:hsl(340deg 80% 20%)}.tag-unix{background-color:hsl(30deg 80% 70%)}.dark .tag-unix{background-color:hsl(30deg 80% 20%)}.tag-web{background-color:hsl(80deg 80% 70%)}.dark .tag-web{background-color:hsl(80deg 80% 20%)}.tag-x86{background-color:hsl(130deg 80% 70%)}.dark .tag-x86{background-color:hsl(130deg 80% 20%)}.tag-x86_64{background-color:hsl(180deg 80% 70%)}.dark .tag-x86_64{background-color:hsl(180deg 80% 20%)}.tag-x86-64{background-color:hsl(230deg 80% 70%)}.dark .tag-x86-64{background-color:hsl(230deg 80% 20%)}.tag-xpath{background-color:hsl(280deg 80% 70%)}.dark .tag-xpath{background-color:hsl(280deg 80% 20%)}.tag-zlib{background-color:hsl(330deg 80% 70%)}.dark .tag-zlib{background-color:hsl(330deg 80% 20%)}</style></head><body><script>localStorage.getItem("dark-theme")&&document.body.classList.add("dark")</script><header><h2 id=banner><a href=/>Infinity Architect</a></h2><div id=top-sections><a href=/android/ class=hoverable>Android </a><a href=/cxx/ class=hoverable>C/C++ </a><a href=/compression/ class=hoverable>Compression </a><a href=/cpu/ class=hoverable>CPU </a><a href=/crypto/ class=hoverable>Cryptography </a><a href=/db/ class=active>Database </a><a href=/ee/ class=hoverable>Electronic Engineering </a><a href=/linux/ class=hoverable>GNU/Linux </a><a href=/go/ class=hoverable>Golang </a><a href=/java/ class=hoverable>Java </a><a href=/microservice/ class=hoverable>Microservice </a><a href=/net/ class=hoverable>Network & Protocol </a><a href=/physics/ class=hoverable>Physics </a><a href=/retro/ class=hoverable>Retro-Computing </a><a href=/toy/ class=hoverable>Toys </a><a href=/windev/ class=hoverable>Window</a></div><div class=theme-switch style="align-self:center;margin:auto 20px"><input type=checkbox id=theme-checkbox>
<label for=theme-checkbox><div></div><span><svg viewBox="0 0 24 24" fill="currentcolor" class="w-6 h-6"><path fill-rule="evenodd" d="M9.528 1.718a.75.75.0 01.162.819A8.97 8.97.0 009 6a9 9 0 009 9 8.97 8.97.0 003.463-.69.75.75.0 01.981.98 10.503 10.503.0 01-9.694 6.46c-5.799.0-10.5-4.701-10.5-10.5.0-4.368 2.667-8.112 6.46-9.694a.75.75.0 01.818.162z" clip-rule="evenodd"/></svg>
</span><span><svg viewBox="0 0 24 24" fill="currentcolor" class="w-6 h-6"><path d="M12 2.25a.75.75.0 01.75.75v2.25a.75.75.0 01-1.5.0V3a.75.75.0 01.75-.75zM7.5 12a4.5 4.5.0 119 0 4.5 4.5.0 01-9 0zM18.894 6.166a.75.75.0 00-1.06-1.06l-1.591 1.59a.75.75.0 101.06 1.061l1.591-1.59zM21.75 12a.75.75.0 01-.75.75h-2.25a.75.75.0 010-1.5H21a.75.75.0 01.75.75zm-3.916 6.894a.75.75.0 001.06-1.06l-1.59-1.591a.75.75.0 10-1.061 1.06l1.59 1.591zM12 18a.75.75.0 01.75.75V21a.75.75.0 01-1.5.0v-2.25A.75.75.0 0112 18zM7.758 17.303a.75.75.0 00-1.061-1.06l-1.591 1.59a.75.75.0 001.06 1.061l1.591-1.59zM6 12a.75.75.0 01-.75.75H3a.75.75.0 010-1.5h2.25A.75.75.0 016 12zm.697-4.243a.75.75.0 001.06-1.06l-1.59-1.591a.75.75.0 00-1.061 1.06l1.59 1.591z"/></svg></span></label></div></header><main><article class=basic-text><div style=font-family:monospace;font-size:1.5em><div class=basic-text>/<a href=/>HOME</a>/<a href=/db/>Database</a>/
$</div></div><div style=margin-bottom:60px><h1 style=margin-bottom:0>MySQL Transaction</h1><p class=aux-text style=margin-top:0>Published at: August 1, 2023
| Last modification: July 20, 2024</p><div style=line-height:2em><span class="page-tag tag-database">database</span>
<span class="page-tag tag-mysql">mysql</span>
<span class="page-tag tag-sql">sql</span>
<span class="page-tag tag-transaction">transaction</span></div></div><div><h2 id=locking>Locking</h2><p>Locking is heavily used in any database system to ensure ACID.</p><p>MyISAM only supports locking at table level, i.e. readers-writer lock on each entire table. No other level of protection are supported. Apparently, such granularity of locking is too large, and is detrimental the concurrency of transactions. Well, MyISAM doesn&rsquo;t support transaction, anyway.</p><p>InnoDB supports transaction, and claim itself supports &ldquo;multiple granularity locking&rdquo;, meaning that both table level and row level locks are supported.</p><p>We only discuss InnoDB here.</p><h3 id=readers-writer-lock-for-row>Readers-Writer Lock for Row</h3><p>The pattern of Readers-Writer Lock are extremely common in MySQL. It is used to protect concurrent accesses to <strong>rows in a table</strong>.</p><p>Reader lock is renamed as &ldquo;shared (S) lock&rdquo; or and writer lock is known as &ldquo;exclusive (X) lock&rdquo;, just as those terms in C++14. Note again that, when we talk about S/X locks, we are talking about row-level locks.</p><p>Some explicit locking SQL statements take extra clause to specify whether you want to acquire a S lock or X lock. The most common one being:</p><div class=codeblock-hook><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>SELECT</span> ... <span style=color:#66d9ef>FOR</span> [<span style=color:#66d9ef>UPDATE</span><span style=color:#f92672>|</span>SHARED];</span></span></code></pre></div><button>copy</button></div><p><code>UPDATE</code> acquires the X lock on the selected rows, and <code>SHARED</code> acquires the X lock, both until the end of the current transaction.</p><h3 id=intention-lock-for-table>Intention Lock for Table</h3><p>Intention lock a pair of table-level readers-writer locks that a transaction must acquire before it can proceed to read/write that table. Their names are &ldquo;intention shared lock (IS)&rdquo; and &ldquo;intention exclusive lock (IX)&rdquo;.</p><p>Intention lock exists primarily for performance reason: <a href=https://stackoverflow.com/questions/33166066/why-do-we-need-intent-lock>https://stackoverflow.com/questions/33166066/why-do-we-need-intent-lock</a></p><p>A protocol is designed</p><h3 id=explicit-locking>Explicit Locking</h3><p>Interestingly enough MySQL exposes some explicit locking interface to the SQL language. I wonder if they have any practical programmatic use. All these functions acquire/release locks for <strong>the current session</strong> (and of course there is no way to get/release locks for other sessions):</p><h4 id=named-lock>Named Lock</h4><div class=codeblock-hook><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#f92672>#</span> acquire a named <span style=color:#66d9ef>lock</span>; negative <span style=color:#f92672>`</span>TIMEOUT<span style=color:#f92672>`</span> blocks forever
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>GET_LOCK(<span style=color:#e6db74>&#34;named_lock&#34;</span>,TIMEOUT); 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#f92672>#</span> released the named <span style=color:#66d9ef>lock</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>RELEASE_LOCK(<span style=color:#e6db74>&#34;named_lock&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#f92672>#</span> trylock
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>IS_FREE_LOCK(<span style=color:#e6db74>&#34;named_lock&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>IS_USED_LOCK(<span style=color:#e6db74>&#34;named_lock&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#f92672>#</span> release <span style=color:#66d9ef>all</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>RELEASE_ALL_LOCKS()</span></span></code></pre></div><button>copy</button></div><h4 id=explicit-table-lock>Explicit Table Lock</h4><p><a href=https://dev.mysql.com/doc/refman/8.0/en/lock-tables.html>https://dev.mysql.com/doc/refman/8.0/en/lock-tables.html</a></p><div class=codeblock-hook><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>LOCK</span> <span style=color:#66d9ef>TABLE</span>[S] <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>table</span><span style=color:#f92672>&gt;</span> [<span style=color:#66d9ef>READ</span><span style=color:#f92672>|</span><span style=color:#66d9ef>WRITE</span>]</span></span></code></pre></div><button>copy</button></div><h3 id=metadata-locking>Metadata Locking</h3><p><a href=https://dev.mysql.com/doc/refman/8.0/en/metadata-locking.html>https://dev.mysql.com/doc/refman/8.0/en/metadata-locking.html</a></p><h3 id=row-locking>Row Locking</h3><h3 id=range-lock-not-a-thing>Range Lock (not a thing?)</h3><h3 id=gap-lock>Gap Lock</h3><h3 id=locking-vs-non-locking-read>Locking vs Non-locking Read</h3><h2 id=isolation-level>Isolation Level</h2><p>Isolation level is the answer to the question: &ldquo;Inside a transaction, to what extent can I observe the results of writes in other transactions that happen concurrently.</p><p>InnoDB supports 4 isolation level, from the lowest protection to the highest:</p><ol><li><p><code>READ UNCOMMITTED</code></p><p>Under RU, reads in a transaction could see writes from other transactions even before those transactions are committed. This is dangerous since one might see partial result. Using RU requires special care.</p><p>The fact that reads inside a transaction see uncommitted writes from other transaction is called &ldquo;dirty reads&rdquo;.</p></li><li><p><code>READ COMMITTED</code></p><p>Under RC, reads in a transaction can only sees changes made by other transactions that have alread committed.</p><p>Each non-locking <code>SELECT</code> inside a transaction see a fresh snapshot, i.e. consecutive non-locking <code>SELECT</code> may see different snapshots.</p><p>2 consequences of such different snapshots are:</p><ol><li>&ldquo;Non-repeatable read&rdquo;: The same row is read twice, but its values changes.</li><li>&ldquo;Phantom rows&rdquo;: The same query is issued twice, but more rows is returned in the second time.</li></ol><p>Under RC, both can happen.</p><p>TOD: Gap locking is never used. Phantom rows can happen.</p></li><li><p><code>REPEATABLE READ</code> (default IL for InnoDB)</p><p>Like RC (i.e. only see committed changes), except:</p><ol><li>multiple non-locking <code>SELECT</code> inside a transaction will see <strong>the same</strong> snapshot, taken when the first <code>SELECT</code> is executed, or when a transaction starts with <code>WITH CONSISTENT SNAPSHOT</code> (RR is also the only IL that allows this clause).</li><li>For statements that requires locking (e.g. <code>UPDATE</code>, <code>DELETE</code>, <code>SELECT ... FOR UPDATE</code>, &mldr;):<ul><li>For unique index with unique search condition, only index record will be locked; gap won&rsquo;t be locked;</li><li>For other search, gap locks or next-key locks will be used.</li></ul></li></ol><p>Under RC, dirty read and non-repeatable read are eliminated, <strong>but phantom read can still happen!</strong>.</p></li><li><p><code>SERIALIZABLE</code></p><p>Like RR, but</p></li></ol><p>Here is a chart for summary:</p><table><thead><tr><th>IL</th><th>Dirty read</th><th>Non-repeatable read</th><th>Phantom read</th></tr></thead><tbody><tr><td>READ UNCOMMITTED</td><td>✓</td><td>✓</td><td>✓</td></tr><tr><td>READ COMMITTED</td><td>x</td><td>✓</td><td>✓</td></tr><tr><td>REPEATABLE READ</td><td>x</td><td>x</td><td>✓</td></tr><tr><td>SERIALIZABLE</td><td>x</td><td>x</td><td>x</td></tr></tbody></table><h3 id=getset-isolation-level>Get/Set isolation level</h3><p>To change server&rsquo;s default isolation level on startup, either use the <code>--transaction-isolation</code> CLI flag or set <code>transaction_isolation</code> sysvar in my.cnf.</p><p>Inside a client, isolation level can be change at global, session, or per transaction level:</p><div class=codeblock-hook><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>SET</span> [<span style=color:#66d9ef>GLOBAL</span><span style=color:#f92672>|</span><span style=color:#66d9ef>SESSION</span>] <span style=color:#66d9ef>TRANSACTION</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>	<span style=color:#66d9ef>ISOLATION</span> <span style=color:#66d9ef>LEVEL</span> [<span style=color:#66d9ef>SERIALIZABLE</span><span style=color:#f92672>|</span><span style=color:#66d9ef>REPEATABLE</span> <span style=color:#66d9ef>READ</span><span style=color:#f92672>|</span><span style=color:#66d9ef>READ</span> <span style=color:#66d9ef>COMMITTED</span><span style=color:#f92672>|</span><span style=color:#66d9ef>READ</span> UNCOMITTED]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>	[<span style=color:#66d9ef>READ</span> <span style=color:#66d9ef>WRITE</span><span style=color:#f92672>|</span><span style=color:#66d9ef>READ</span> <span style=color:#66d9ef>ONLY</span>] <span style=color:#f92672>#</span> <span style=color:#66d9ef>access</span> <span style=color:#66d9ef>mode</span> can be <span style=color:#66d9ef>set</span> <span style=color:#66d9ef>at</span> the same time</span></span></code></pre></div><button>copy</button></div><p>Such <code>SET TRANSACTION</code> can appear either between transactions, or inside a transaction. Note that the <code>SET</code> statement is not part of a transaction, since it does not read/write data or change data definition. The scopes are:</p><ol><li><code>GLOBAL</code> changes the isolation level globally for all new session; existing session are unaffected.</li><li><code>SESSION</code> changes the IL for all subsequent transactions in the current session. If appears inside a transaction, it does not affect that ongoing transaction.</li><li>If neither of <code>GLOBAL</code> or <code>SESSION</code> is presented, the isolation level is only changed for the next transaction in the current session. Then IL will be reset to the session scope IL.</li></ol><p>Get the current IL:</p><div class=codeblock-hook><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>Global</span>.transaction_isolation; <span style=color:#f92672>#</span> <span style=color:#66d9ef>global</span> IL
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@@</span><span style=color:#66d9ef>Session</span>.transaction_isolation; <span style=color:#f92672>#</span> <span style=color:#66d9ef>session</span> IL
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>@@</span>transaction_isolation; <span style=color:#f92672>#</span> IL <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>next</span> <span style=color:#66d9ef>transaction</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#f92672>#</span> Note that <span style=color:#66d9ef>in</span> autocommit <span style=color:#66d9ef>mode</span>, such <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>is</span> also a <span style=color:#66d9ef>transaction</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#f92672>#</span> meaning that <span style=color:#66d9ef>any</span> change <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>next</span><span style=color:#f92672>-</span><span style=color:#66d9ef>transaction</span> IL will be <span style=color:#66d9ef>reset</span> <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>session</span> IL,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#f92672>#</span> <span style=color:#66d9ef>and</span> the <span style=color:#66d9ef>last</span> <span style=color:#66d9ef>SELECT</span> doesn<span style=color:#e6db74>&#39;t reflect the change.</span></span></span></code></pre></div><button>copy</button></div><h2 id=rollback>Rollback</h2><p>Cascade rollback:</p><h2 id=snapshot-isolation--consistent-read--multiversioning>Snapshot Isolation / Consistent Read / Multiversioning</h2><p>Consistent read refers to the fact that, for plain lock-less <code>SELECT</code> (in contrary to <code>SELECT ... FOR [SHARED|UPDATE]</code> which locks rows), MySQL provides a snapshot of the database, instead of actually trying to acquire locks for tables/rows. This features enables a non-blocking plain <code>SELECT</code>, even when querying rows locked by other transaction.</p><p>Given that the isolation level is, &ldquo;The moment&rdquo; is one of the following:</p><ol><li>The first (?) <code>SELECT</code> in the transaction.</li><li><code>START TRANSACTION WITH CONSISTENT SNAPSHOT</code></li></ol><h2 id=implicit-committing>Implicit Committing</h2><p>Some statements end the current transaction implicitly, as if a <code>COMMIT</code> were issued before them:</p><p><a href=https://dev.mysql.com/doc/refman/8.0/en/implicit-commit.html>https://dev.mysql.com/doc/refman/8.0/en/implicit-commit.html</a></p><h2 id=write-write-conflict>Write-Write Conflict</h2><h2 id=distributed-xa-transaction--2-phase-commit>Distributed (XA) Transaction / 2 Phase Commit</h2><p><a href=https://dev.mysql.com/doc/refman/8.0/en/xa.html>https://dev.mysql.com/doc/refman/8.0/en/xa.html</a></p></div></article></main><footer>Unless otherwise noted, content of this site is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ style=text-decoration:underline>the CC BY-NC-SA 4.0</a>.<br>cesun.info copyright 2024.</footer></body></html>